<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Estimate | Sagar Borewells</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/layout.js"></script>
    <script src="assets/js/quote_constants.js"></script> 
    <script src="assets/js/pdf_template.js"></script>

    <style>
        :root { --primary: #1d4ed8; --drill-dark: #0f172a; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #020617; color: #e2e8f0; overflow-x: hidden; }
        
        /* --- 3D DRILL BIT ASSEMBLY --- */
        .drill-rig-stage {
            position: relative; height: 600px; width: 100%;
            background: #0f172a; border-left: 2px solid #1e293b;
            display: flex; justify-content: center;
            overflow: hidden;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.8);
        }

        .geo-layers {
            position: absolute; inset: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, #5d4037 0%, #a1887f 15%, #546e7a 40%, #263238 100%);
            opacity: 0.2; z-index: 0;
        }

        /* The Draggable Track */
        .drill-track {
            position: relative; height: 100%; width: 120px;
            z-index: 10; cursor: grab;
        }
        .drill-track:active { cursor: grabbing; }

        /* The Hammer (Visual) */
        .hammer-assembly {
            position: absolute; left: 50%; top: 0;
            width: 50px; height: 140px;
            transform: translateX(-50%) translateY(-95%); /* Tip at cursor */
            z-index: 20;
            will-change: transform, top;
        }

        /* Realistic Texture via CSS Gradient */
        .hammer-body {
            width: 100%; height: 100%;
            background: 
                /* Shine */
                linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%),
                /* Metal Color */
                linear-gradient(to right, #1e293b, #475569, #1e293b);
            border-radius: 4px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
        }

        /* Tungsten Buttons (Red Tips) */
        .hammer-head {
            width: 110%; height: 20px; background: #334155;
            border-bottom: 4px solid #b91c1c; /* Carbide */
            border-radius: 0 0 10px 10px;
            margin-bottom: -5px;
        }

        /* Animations */
        .drilling { animation: vibrate 0.05s infinite linear; }
        @keyframes vibrate {
            0% { transform: translateX(-50%) translateY(-95%) rotate(0deg); }
            25% { transform: translateX(-51%) translateY(-94%) rotate(1deg); }
            50% { transform: translateX(-50%) translateY(-95%) rotate(0deg); }
            75% { transform: translateX(-49%) translateY(-96%) rotate(-1deg); }
            100% { transform: translateX(-50%) translateY(-95%) rotate(0deg); }
        }

        /* Dirt Particles */
        .dust-particle {
            position: absolute; width: 6px; height: 6px;
            background: #a1887f; border-radius: 50%;
            pointer-events: none; opacity: 0.8;
            z-index: 15;
        }

        /* Borehole Darkness */
        .borehole-shaft {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 20px; background: #000; height: 0%;
            box-shadow: inset 0 0 10px rgba(0,0,0,1);
            transition: height 0.05s linear; z-index: 5;
        }

        /* UI Elements */
        .depth-marker {
            position: absolute; right: 10px; color: rgba(255,255,255,0.3);
            font-size: 10px; font-weight: bold; transform: translateY(-50%);
            pointer-events: none;
        }

        .depth-hud {
            position: absolute; top: 20px; right: 20px; text-align: right; z-index: 30;
        }
        .hud-val { font-size: 4rem; font-weight: 900; line-height: 1; color: white; text-shadow: 0 0 20px rgba(37,99,235,0.5); }
        .hud-lbl { color: #94a3b8; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; font-size: 0.8rem; }

        /* Form Styling */
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid #334155; }
        .input-dark { background: #020617; border: 1px solid #334155; color: white; transition: 0.3s; }
        .input-dark:focus { border-color: #2563eb; box-shadow: 0 0 0 2px rgba(37,99,235,0.2); outline: none; }
        
        .est-table td, .est-table th { padding: 12px; border-bottom: 1px solid #334155; text-align: left; }
        .est-table th { color: #94a3b8; text-transform: uppercase; font-size: 0.7rem; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="navbar-mount"></div>

    <main class="flex-grow flex flex-col md:flex-row h-[calc(100vh-80px)]">
        
        <div class="w-full md:w-1/2 p-8 md:p-12 overflow-y-auto bg-slate-900 z-20 shadow-2xl" id="formPanel">
            <div class="max-w-lg mx-auto">
                <h1 class="text-3xl font-extrabold text-white mb-2">Estimate Engine <span class="text-blue-500">v2.0</span></h1>
                <p class="text-slate-400 text-sm mb-8">Configure your drilling parameters.</p>

                <div class="space-y-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Client Details</label>
                        <input type="text" id="custName" class="w-full p-4 rounded-xl input-dark mb-3" placeholder="Full Name">
                        
                        <div class="relative">
                            <input type="tel" id="custMobile" class="w-full p-4 rounded-xl input-dark pl-4 pr-24" placeholder="Mobile Number" maxlength="10">
                            <button id="verifyBtn" onclick="sendOTP()" class="absolute right-2 top-2 bottom-2 px-4 bg-blue-600 text-white rounded-lg text-xs font-bold hover:bg-blue-500 transition">VERIFY</button>
                            <div id="verifiedBadge" class="absolute right-4 top-4 text-emerald-400 font-bold text-xs hidden"><i class="ri-check-double-line"></i> VERIFIED</div>
                        </div>
                        
                        <div id="otpBox" class="hidden mt-2 flex gap-2 animate-pulse">
                            <input type="text" id="otpInput" class="flex-1 p-3 rounded-xl input-dark text-center tracking-widest" placeholder="ENTER OTP">
                            <button onclick="verifyOTP()" class="px-6 bg-emerald-600 text-white rounded-xl font-bold">OK</button>
                        </div>
                        <div id="recaptcha-container"></div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Drill Site</label>
                        <div class="relative">
                            <input type="text" id="locInput" class="w-full p-4 rounded-xl input-dark pr-32" placeholder="Search Location...">
                            <div class="absolute right-2 top-2 bottom-2 flex gap-1">
                                <button onclick="detectGPS()" class="px-3 bg-slate-800 text-blue-400 rounded-lg hover:bg-slate-700"><i class="ri-gps-fill"></i></button>
                                <button onclick="openMiniMap()" class="px-3 bg-slate-800 text-white rounded-lg hover:bg-slate-700"><i class="ri-map-2-line"></i></button>
                            </div>
                        </div>
                        <p id="distDisplay" class="text-xs text-right mt-2 text-slate-500 font-mono h-4"></p>
                    </div>

                    <button id="genBtn" onclick="calculate()" class="w-full py-5 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-2xl shadow-lg shadow-blue-900/50 transition transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        CALCULATE ESTIMATE <i class="ri-arrow-right-line ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="w-full md:w-1/2 relative bg-slate-950">
            
            <div class="depth-hud pointer-events-none">
                <div class="hud-val" id="depthReadout">100</div>
                <div class="hud-lbl">Target Depth (FT)</div>
                <div id="expertBadge" class="hidden mt-2 bg-red-500/20 border border-red-500 text-red-400 px-3 py-1 rounded text-xs font-bold animate-pulse">
                    ‚ö†Ô∏è HIGH DEPTH
                </div>
            </div>

            <div class="drill-rig-stage" id="drillStage">
                <div class="geo-layers"></div>
                
                <div class="drill-track" id="drillTrack">
                    <div class="borehole-shaft" id="shaft"></div>
                    
                    <div class="hammer-assembly" id="hammer">
                        <div class="hammer-body">
                            <div class="hammer-head"></div>
                        </div>
                    </div>
                    
                    <div id="dirtEmitter" class="absolute left-1/2" style="top:0; width:1px; height:1px;"></div>
                </div>

                <div id="scaleMarkers" class="absolute right-0 top-0 bottom-0 w-20 pointer-events-none"></div>
            </div>

            <div class="absolute bottom-8 left-8 right-8 flex justify-center gap-4">
                <button onclick="setDepth(200)" class="glass-panel px-4 py-2 rounded-lg text-xs font-bold text-slate-300 hover:text-white hover:border-blue-500 transition">200 FT</button>
                <button onclick="setDepth(500)" class="glass-panel px-4 py-2 rounded-lg text-xs font-bold text-slate-300 hover:text-white hover:border-blue-500 transition">500 FT</button>
                <button onclick="setDepth(1000)" class="glass-panel px-4 py-2 rounded-lg text-xs font-bold text-slate-300 hover:text-white hover:border-blue-500 transition">1000 FT</button>
            </div>
        </div>

    </main>

    <div id="invoiceModal" class="fixed inset-0 z-50 bg-black/90 hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-3xl rounded-2xl overflow-hidden shadow-2xl animate-fade-up">
            <div class="bg-slate-900 p-6 flex justify-between items-center border-b-4 border-blue-600">
                <h2 class="text-2xl font-black text-white">ESTIMATE</h2>
                <button onclick="closeInvoice()" class="text-slate-400 hover:text-white"><i class="ri-close-circle-line text-3xl"></i></button>
            </div>
            <div class="p-8 max-h-[70vh] overflow-y-auto">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <div class="text-sm text-slate-500 font-bold uppercase">Total Cost</div>
                        <div class="text-4xl font-extrabold text-blue-700" id="finalTotal">‚Çπ0</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-bold text-slate-900" id="finalRef">--</div>
                        <div class="text-xs text-slate-500">Reference ID</div>
                    </div>
                </div>

                <table class="est-table w-full mb-6">
                    <thead><tr><th>Description</th><th class="text-right">Amount</th></tr></thead>
                    <tbody id="invoiceBody" class="text-slate-700 text-sm"></tbody>
                </table>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="downloadPDF()" class="py-3 border-2 border-slate-200 rounded-xl font-bold text-slate-600 hover:bg-slate-50">Download PDF</button>
                    <button onclick="confirmBooking()" class="py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg">Confirm Booking</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // üü¢ CONFIG LOAD
        const CFG = (typeof QUOTE_CONFIG !== 'undefined') ? QUOTE_CONFIG : { PRICING_MODEL:{base_rate:70}, MATERIALS:[] };
        
        // üü¢ PHYSICS ENGINE VARIABLES
        const track = document.getElementById('drillTrack');
        const hammer = document.getElementById('hammer');
        const shaft = document.getElementById('shaft');
        const emitter = document.getElementById('dirtEmitter');
        const readout = document.getElementById('depthReadout');
        
        let isDragging = false;
        let currentDepth = 100;
        let maxScale = 500;
        let lastY = 0;

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            renderScale();
            updatePhysics(100); // Start at 100ft
            
            // Events
            track.addEventListener('mousedown', startDrag);
            window.addEventListener('mousemove', onDrag);
            window.addEventListener('mouseup', stopDrag);
            
            track.addEventListener('touchstart', startDrag);
            window.addEventListener('touchmove', onDrag);
            window.addEventListener('touchend', stopDrag);
        });

        // üü¢ DRAG LOGIC (The "Elastic" Feel)
        function startDrag(e) {
            isDragging = true;
            hammer.classList.add('drilling'); // Vibrate
            e.preventDefault();
        }

        function stopDrag() {
            isDragging = false;
            hammer.classList.remove('drilling');
        }

        function onDrag(e) {
            if(!isDragging) return;
            
            const rect = track.getBoundingClientRect();
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            let relativeY = clientY - rect.top;
            
            // Clamp
            relativeY = Math.max(0, Math.min(relativeY, rect.height));
            
            // Calc Depth
            const pct = relativeY / rect.height;
            let rawDepth = Math.round(pct * maxScale);
            
            // Snap to 10ft
            let targetDepth = Math.max(100, Math.round(rawDepth / 10) * 10);
            
            // Physics Direction (Down = Drill, Up = Retract)
            if (targetDepth > currentDepth) {
                spawnDirt(5); // Spew particles when going deeper
            }
            
            currentDepth = targetDepth;
            
            // üü¢ ELASTIC SCALE LOGIC
            // Expand if hitting bottom
            if (pct > 0.95 && maxScale < 1500) {
                maxScale += 300; // Snap expand
                isDragging = false; // Reset drag to re-orient
                renderScale();
                updatePhysics(currentDepth);
            }
            // Contract if pulling up high
            if (currentDepth < (maxScale - 600) && maxScale > 500) {
                maxScale -= 300;
                isDragging = false;
                renderScale();
                updatePhysics(currentDepth);
            }

            // High Depth Warning
            if(currentDepth >= 600) document.getElementById('expertBadge').classList.remove('hidden');
            else document.getElementById('expertBadge').classList.add('hidden');

            // UI Update via RequestAnimationFrame for smoothness
            requestAnimationFrame(() => updatePhysics(currentDepth));
        }

        function updatePhysics(depth) {
            readout.innerText = depth;
            const pct = (depth / maxScale) * 100;
            
            hammer.style.top = pct + "%";
            shaft.style.height = pct + "%";
            emitter.style.top = pct + "%";
        }

        function renderScale() {
            const el = document.getElementById('scaleMarkers');
            el.innerHTML = '';
            const step = maxScale / 5;
            for(let i=1; i<=5; i++) {
                const d = Math.round(step * i);
                const mark = document.createElement('div');
                mark.className = 'depth-marker';
                mark.style.top = (i * 20) + '%';
                mark.innerText = d + 'ft -';
                el.appendChild(mark);
            }
        }

        // üü¢ PARTICLE SYSTEM ("Dirt Pouring")
        function spawnDirt(count) {
            for(let i=0; i<count; i++) {
                const p = document.createElement('div');
                p.className = 'dust-particle';
                
                // Randomize trajectory (Fly UP and OUT)
                const angle = (Math.random() * 60 - 30); // Spread
                const speed = Math.random() * 100 + 50;
                
                p.style.top = emitter.style.top;
                p.style.left = '50%';
                
                track.appendChild(p);

                // Animate
                const anim = p.animate([
                    { transform: `translate(-50%, 0) scale(1)`, opacity: 0.8 },
                    { transform: `translate(${angle}px, -${speed}px) scale(0)`, opacity: 0 }
                ], {
                    duration: 600,
                    easing: 'ease-out'
                });

                anim.onfinish = () => p.remove();
            }
        }

        function setDepth(val) {
            currentDepth = val;
            while(currentDepth > maxScale) maxScale += 500; // Auto expand
            renderScale();
            updatePhysics(val);
        }

        // üü¢ CALCULATION ENGINE (Updated)
        let leadData = {};

        function calculate() {
            const { PRICING_MODEL, LABOUR_CHARGE, TRANSPORT_THRESHOLD_KM, TRANSPORT_BASE_RATE, MATERIALS } = CFG;
            const jumps = PRICING_MODEL.increments;
            const bounds = PRICING_MODEL.boundaries;
            
            let total = 0;
            let html = '';
            let d = 0; // tracked depth
            let rate = PRICING_MODEL.base_rate;

            // 1. Base Block
            const baseChunk = Math.min(currentDepth, 100);
            if(baseChunk > 0) {
                total += baseChunk * rate;
                html += `<tr><td>0 - ${baseChunk}ft (@ ‚Çπ${rate})</td><td class="text-right">‚Çπ${(baseChunk*rate).toLocaleString()}</td></tr>`;
                d += baseChunk;
            }

            // 2. Loop Slabs
            while(d < currentDepth) {
                if (d >= bounds.phase_3_start) rate += jumps.phase_3;
                else if (d >= bounds.phase_2_start) rate += jumps.phase_2;
                else rate += jumps.phase_1;

                let chunk = Math.min(50, currentDepth - d);
                total += chunk * rate;
                html += `<tr><td>${d+1} - ${d+chunk}ft (@ ‚Çπ${rate})</td><td class="text-right">‚Çπ${(chunk*rate).toLocaleString()}</td></tr>`;
                d += chunk;
            }

            // Ops
            total += LABOUR_CHARGE;
            html += `<tr><td class="font-bold">Heavy Machinery Labour</td><td class="text-right">‚Çπ${LABOUR_CHARGE.toLocaleString()}</td></tr>`;

            // Transport (Mock dist for now if not set)
            // In real usage, transportDist is set by Maps
            
            document.getElementById('finalTotal').innerText = "‚Çπ" + total.toLocaleString();
            document.getElementById('invoiceBody').innerHTML = html;
            document.getElementById('finalRef').innerText = `QT-${Date.now().toString().slice(-4)}`;
            
            // Show Modal
            document.getElementById('invoiceModal').classList.remove('hidden');
            document.getElementById('invoiceModal').classList.add('flex');
        }

        function closeInvoice() {
            document.getElementById('invoiceModal').classList.add('hidden');
            document.getElementById('invoiceModal').classList.remove('flex');
        }

        // üü¢ AUTH & MAPS (Boilerplate)
        if(typeof firebase !== 'undefined' && CONTACT_INFO.firebase_config) {
            if(!firebase.apps.length) firebase.initializeApp(CONTACT_INFO.firebase_config);
            const auth = firebase.auth();
            auth.onAuthStateChanged(user => {
                if(user) {
                    document.getElementById('custMobile').value = user.phoneNumber.replace('+91','');
                    document.getElementById('genBtn').disabled = false;
                    document.getElementById('verifiedBadge').classList.remove('hidden');
                    document.getElementById('verifyBtn').classList.add('hidden');
                }
            });
        }

        // Mock functions for demo if APIs not loaded
        function sendOTP() { alert("Simulated OTP Sent"); document.getElementById('otpBox').classList.remove('hidden'); }
        function verifyOTP() { document.getElementById('otpBox').classList.add('hidden'); document.getElementById('genBtn').disabled = false; }
        function detectGPS() { alert("GPS Detecting..."); }
    </script>
</body>
</html>
