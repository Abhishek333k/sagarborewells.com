<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sagar Borewells | Enterprise OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="assets/js/config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #0f172a; color: white; overflow-x: hidden; }
        
        /* Modal Animation */
        .modal-enter { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .modal-active { opacity: 1; transform: scale(1); pointer-events: auto; }
        .transition-modal { transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1); }

        /* Glass Cards */
        .glass-panel { background: #1e293b; border: 1px solid #334155; }
        .invoice-paper { background: white; color: #0f172a; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* Map Picker */
        #miniMap { height: 300px; width: 100%; border-radius: 8px; margin-top: 10px; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <nav class="bg-[#0f172a]/90 backdrop-blur border-b border-slate-800 p-4 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="h-8 w-8 bg-blue-600 rounded flex items-center justify-center font-bold">S</div>
                <h1 class="text-xl font-bold tracking-tight">SAGAR <span class="text-blue-500">OPS</span></h1>
            </div>
            <div class="flex gap-4">
                <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded-lg text-sm font-bold shadow-lg shadow-blue-500/20 transition flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i> New Estimate
                </button>
            </div>
        </div>
    </nav>

    <main class="flex-grow p-6">
        <div class="max-w-7xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                <div class="glass-panel p-6 rounded-2xl">
                    <p class="text-slate-400 text-xs font-bold uppercase">System Status</p>
                    <h2 class="text-2xl font-bold mt-1 text-emerald-400"><i class="fa-solid fa-circle text-[10px] animate-pulse"></i> Operational</h2>
                </div>
                <div class="glass-panel p-6 rounded-2xl">
                    <p class="text-slate-400 text-xs font-bold uppercase">Today's Leads</p>
                    <h2 class="text-2xl font-bold mt-1">0</h2>
                </div>
                <div class="glass-panel p-6 rounded-2xl">
                    <p class="text-slate-400 text-xs font-bold uppercase">Avg Depth (Jan)</p>
                    <h2 class="text-2xl font-bold mt-1">540 ft</h2>
                </div>
            </div>

            <div class="text-center py-20 border border-dashed border-slate-800 rounded-3xl bg-slate-900/50">
                <div class="h-16 w-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-600 text-2xl">
                    <i class="fa-solid fa-calculator"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-300">Ready to Generate</h3>
                <p class="text-slate-500 text-sm mt-2 mb-6">Create professional estimates instantly.</p>
                <button onclick="openModal()" class="text-blue-400 hover:text-blue-300 font-bold text-sm">Open Estimator &rarr;</button>
            </div>
        </div>
    </main>

    <div id="estModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm transition-modal modal-enter">
        <div class="bg-[#0f172a] w-full max-w-4xl h-[90vh] md:h-auto md:max-h-[90vh] rounded-2xl border border-slate-700 shadow-2xl overflow-hidden flex flex-col md:flex-row">
            
            <div class="w-full md:w-1/2 p-6 overflow-y-auto border-b md:border-b-0 md:border-r border-slate-700">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold">Project Details</h2>
                    <button onclick="closeModal()" class="text-slate-500 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>

                <div class="space-y-5">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Name</label>
                            <input type="text" id="custName" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-sm text-white focus:border-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Mobile</label>
                            <input type="tel" id="custMobile" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-sm text-white focus:border-blue-500 outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 flex justify-between">
                            <span>Site Location</span>
                            <span id="locStatus" class="text-blue-400 hidden"><i class="fa-solid fa-check"></i> Locked</span>
                        </label>
                        <div class="flex gap-2">
                            <input type="text" id="locInput" placeholder="Search Area..." class="flex-grow bg-slate-800 border border-slate-600 rounded p-2 text-sm text-white outline-none">
                            
                            <button onclick="detectGPS()" class="bg-slate-700 hover:bg-slate-600 text-white p-2 rounded w-10 border border-slate-600" title="Use GPS">
                                <i class="fa-solid fa-crosshairs"></i>
                            </button>
                            <button onclick="toggleMap()" class="bg-blue-600 hover:bg-blue-500 text-white p-2 rounded w-10 shadow-lg" title="Pick on Map">
                                <i class="fa-solid fa-map-location-dot"></i>
                            </button>
                        </div>
                        <div id="mapContainer" class="hidden mt-2 relative">
                            <div id="miniMap"></div>
                            <button onclick="confirmMapPick()" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-xs font-bold px-4 py-2 rounded-full shadow-xl border border-slate-700 z-10">
                                Confirm Pin
                            </button>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-800/50 rounded-xl border border-slate-700/50">
                        <div class="flex justify-between mb-2">
                            <label class="text-xs font-bold text-slate-400 uppercase">Depth: <span id="depthVal" class="text-white">500</span> ft</label>
                        </div>
                        <input type="range" id="depthSlider" min="100" max="1500" value="500" step="10" class="w-full h-2 bg-slate-600 rounded-lg accent-blue-500 mb-4" oninput="updateCalc()">
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Purpose</label>
                                <select id="purposeInput" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-xs text-white" onchange="updateCalc()">
                                    <option value="residential">Residential</option>
                                    <option value="agriculture">Agriculture</option>
                                    <option value="commercial">Commercial</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Casing</label>
                                <select id="casingType" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-xs text-white" onchange="updateCalc()">
                                    <option value="350">PVC (Std)</option>
                                    <option value="450">PVC (Heavy)</option>
                                    <option value="650">Iron</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <button onclick="generatePreview()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-lg shadow-blue-500/20">
                        Generate Invoice Preview
                    </button>
                </div>
            </div>

            <div class="w-full md:w-1/2 bg-slate-900 p-6 flex flex-col justify-between relative">
                
                <div id="previewBlank" class="absolute inset-0 flex flex-col items-center justify-center text-slate-600">
                    <i class="fa-solid fa-file-invoice text-4xl mb-4"></i>
                    <p class="text-sm font-bold">Waiting for input...</p>
                </div>

                <div id="previewContent" class="hidden h-full flex flex-col">
                    <div class="invoice-paper p-6 flex-grow overflow-y-auto text-xs">
                        <div class="flex justify-between border-b border-slate-200 pb-4 mb-4">
                            <div>
                                <h3 class="text-lg font-extrabold text-blue-600">SAGAR OPS</h3>
                                <p class="text-slate-500">Official Estimate</p>
                            </div>
                            <div class="text-right">
                                <p class="text-slate-400 uppercase text-[10px]">Grand Total</p>
                                <p class="text-2xl font-bold text-slate-800" id="invTotal">â‚¹0</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-4 text-[10px] text-slate-500">
                            <div>CLIENT: <span id="invName" class="font-bold text-slate-800">--</span></div>
                            <div>LOC: <span id="invLoc" class="font-bold text-slate-800">--</span></div>
                        </div>

                        <table class="w-full mb-4">
                            <thead class="bg-slate-50 text-slate-500 border-b border-slate-200">
                                <tr>
                                    <th class="text-left py-2 pl-2">Description</th>
                                    <th class="text-right py-2 pr-2">Amount</th>
                                </tr>
                            </thead>
                            <tbody id="invBody" class="text-slate-700">
                                </tbody>
                        </table>
                        
                        <div class="bg-yellow-50 p-2 rounded border border-yellow-100 text-yellow-700 text-[10px]">
                            *Excludes GST & Casing. Subject to site survey.
                        </div>
                    </div>

                    <div class="mt-4 flex gap-3">
                        <button onclick="saveAndSend()" class="flex-grow py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg shadow-lg flex justify-center items-center gap-2">
                            <i class="fa-brands fa-whatsapp"></i> Send Quote
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const SLAB_INCREMENT = 50;
        const JUMP_AMOUNT = 5;
        const BASE_RATES = { 'residential': 90, 'agriculture': 85, 'commercial': 110 };
        const FIXED_COSTS = 7000;

        let mapObj, markerObj;
        let leadData = {};

        // 1. MODAL LOGIC
        function openModal() {
            document.getElementById('estModal').classList.remove('modal-enter');
            document.getElementById('estModal').classList.add('modal-active');
        }
        function closeModal() {
            document.getElementById('estModal').classList.remove('modal-active');
            document.getElementById('estModal').classList.add('modal-enter');
        }

        // 2. LOCATION LOGIC
        function detectGPS() {
            const btn = document.querySelector('button[onclick="detectGPS()"]');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    // Reverse Geocode (Mock for now, normally uses Google API)
                    document.getElementById('locInput').value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                    btn.innerHTML = '<i class="fa-solid fa-crosshairs"></i>';
                }, () => { alert('GPS Denied'); btn.innerHTML = '<i class="fa-solid fa-crosshairs"></i>'; });
            }
        }

        function toggleMap() {
            const container = document.getElementById('mapContainer');
            container.classList.toggle('hidden');
            
            if(!container.classList.contains('hidden') && !mapObj) {
                // Initialize Map ONCE
                if(window.google) {
                    mapObj = new google.maps.Map(document.getElementById('miniMap'), {
                        center: {lat: 16.4428, lng: 80.5645}, // Mangalagiri
                        zoom: 13,
                        disableDefaultUI: true
                    });
                    
                    // Center Marker
                    markerObj = new google.maps.Marker({
                        position: mapObj.getCenter(),
                        map: mapObj,
                        draggable: false
                    });

                    mapObj.addListener('center_changed', () => {
                        markerObj.setPosition(mapObj.getCenter());
                    });
                }
            }
        }

        function confirmMapPick() {
            if(mapObj) {
                const c = mapObj.getCenter();
                document.getElementById('locInput').value = `${c.lat().toFixed(5)}, ${c.lng().toFixed(5)}`;
                document.getElementById('mapContainer').classList.add('hidden');
            }
        }

        // 3. CALCULATION ENGINE
        function updateCalc() {
            document.getElementById('depthVal').innerText = document.getElementById('depthSlider').value;
        }

        function generatePreview() {
            // Get Data
            const name = document.getElementById('custName').value || "Valued Customer";
            const loc = document.getElementById('locInput').value || "Unknown";
            const depth = parseInt(document.getElementById('depthSlider').value);
            const purpose = document.getElementById('purposeInput').value;
            
            // Calculate
            let remaining = depth;
            let floor = 0;
            let currentRate = BASE_RATES[purpose];
            let drillTotal = 0;
            let rowsHTML = "";

            while(remaining > 0) {
                let chunk = (remaining >= SLAB_INCREMENT) ? SLAB_INCREMENT : remaining;
                let chunkCost = chunk * currentRate;
                drillTotal += chunkCost;

                rowsHTML += `
                    <tr>
                        <td class="py-1 pl-2 border-b border-slate-100">${floor}-${floor+chunk}ft @ â‚¹${currentRate}</td>
                        <td class="py-1 pr-2 text-right border-b border-slate-100">â‚¹${chunkCost.toLocaleString()}</td>
                    </tr>
                `;
                
                remaining -= chunk;
                floor += chunk;
                currentRate += JUMP_AMOUNT;
            }

            const grandTotal = drillTotal + FIXED_COSTS;

            // Render Invoice
            document.getElementById('invName').innerText = name;
            document.getElementById('invLoc').innerText = loc;
            
            let finalHTML = rowsHTML;
            finalHTML += `
                <tr class="bg-slate-50 font-bold text-slate-500">
                    <td class="py-2 pl-2">Fixed Costs (Transport/Setup)</td>
                    <td class="py-2 pr-2 text-right">â‚¹${FIXED_COSTS.toLocaleString()}</td>
                </tr>
            `;

            document.getElementById('invBody').innerHTML = finalHTML;
            document.getElementById('invTotal').innerText = "â‚¹" + grandTotal.toLocaleString();

            // Save Data
            leadData = { name, mobile: document.getElementById('custMobile').value, loc, depth, total: grandTotal };

            // Show UI
            document.getElementById('previewBlank').classList.add('hidden');
            document.getElementById('previewContent').classList.remove('hidden');
        }

        // 4. SAVE & SEND
        function saveAndSend() {
            const btn = document.querySelector('button[onclick="saveAndSend()"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = "Saving...";

            // Send to Google Sheet
            const formData = new FormData();
            formData.append("name", leadData.name);
            formData.append("mobile", leadData.mobile);
            formData.append("location", leadData.loc);
            formData.append("depth", leadData.depth);
            formData.append("price", leadData.total);
            formData.append("purpose", "Official Quote");

            fetch(CONTACT_INFO.database_url, { method: "POST", body: formData, mode: "no-cors" })
            .then(() => {
                const msg = `*OFFICIAL ESTIMATE*%0A%0AðŸ‘¤ ${leadData.name}%0AðŸ“ ${leadData.loc}%0AðŸ“‰ Depth: ${leadData.depth}ft%0AðŸ’° *Total:* â‚¹${leadData.total.toLocaleString()}%0A%0APlease approve to schedule rig.`;
                window.open(`https://wa.me/${CONTACT_INFO.whatsapp_api}?text=${msg}`, '_blank');
                btn.innerHTML = "Sent!";
                setTimeout(() => { btn.innerHTML = originalHTML; }, 2000);
            })
            .catch(e => {
                console.error(e);
                alert("Saved locally. Opening WhatsApp.");
                btn.innerHTML = originalHTML;
            });
        }
    </script>
    
    <script>
        const s = document.createElement('script');
        s.src = `https://maps.googleapis.com/maps/api/js?key=${CONTACT_INFO.google_maps_key}&libraries=places`;
        s.async = true; s.defer = true;
        document.body.appendChild(s);
    </script>

</body>
</html>
