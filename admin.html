<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sagar Admin Console</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/pdf_template.js"></script>
    <script src="assets/js/certificate_template.js"></script>

    <style>
        :root { --bg-dark: #09090b; --panel: #18181b; --border: #27272a; --accent: #2563eb; }
        body { background-color: var(--bg-dark); color: #e4e4e7; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* SLICK CARD */
        .data-card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; transition: 0.2s; }
        .data-card:active { transform: scale(0.98); border-color: var(--accent); }
        
        /* INPUTS */
        .pro-input { background: #000000; border: 1px solid var(--border); color: white; padding: 10px 14px; border-radius: 8px; width: 100%; outline: none; font-size: 13px; font-family: 'Inter', sans-serif; }
        .pro-input:focus { border-color: var(--accent); }
        
        /* MODAL TRANSITION */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; align-items: center; justify-content: center; padding: 16px; backdrop-filter: blur(4px); }
        .modal.open { display: flex; animation: slideUp 0.2s ease-out; }
        .modal-box { background: #121212; border: 1px solid #333; width: 100%; max-width: 450px; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        
        /* BOTTOM NAV */
        .nav-dock { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(24, 24, 27, 0.9); backdrop-filter: blur(10px); border: 1px solid var(--border); padding: 8px 20px; border-radius: 100px; display: flex; gap: 24px; z-index: 50; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .dock-icon { color: #71717a; font-size: 20px; transition: 0.2s; position: relative; padding: 8px; }
        .dock-icon.active { color: white; background: #27272a; border-radius: 50%; }
        .dock-icon.active::after { content: ''; width: 4px; height: 4px; background: var(--accent); border-radius: 50%; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); }

        @media (min-width: 768px) {
            .nav-dock { display: none; }
            .sidebar { width: 240px; height: 100vh; position: fixed; background: var(--panel); border-right: 1px solid var(--border); padding: 20px; }
            .workspace { margin-left: 240px; padding: 40px; }
        }
        @media (max-width: 767px) { .sidebar { display: none; } .workspace { padding: 16px; padding-bottom: 100px; } }
    </style>
</head>
<body>

    <div id="init-screen" class="fixed inset-0 bg-black z-[200] flex items-center justify-center">
        <div class="text-xs font-mono text-slate-500 animate-pulse tracking-widest">SYSTEM INITIALIZING</div>
    </div>

    <div id="login-overlay" class="fixed inset-0 bg-black z-[150] flex flex-col items-center justify-center p-6 hidden">
        <div class="w-full max-w-sm">
            <div class="text-center mb-10">
                <div class="w-12 h-12 bg-white rounded flex items-center justify-center mx-auto mb-4 text-black font-black text-xl">S</div>
                <h1 class="text-xl font-bold tracking-tight">Admin Console</h1>
            </div>
            <div class="space-y-4">
                <input type="tel" id="adminPhone" class="pro-input text-center text-lg py-3" placeholder="Mobile Number" maxlength="10">
                <button id="sendOtpBtn" onclick="sendAdminOTP()" class="w-full bg-white text-black font-bold py-3 rounded-lg hover:bg-gray-200">AUTHENTICATE</button>
                <div id="otp-group" class="hidden space-y-4">
                    <input type="text" id="adminOtp" class="pro-input text-center text-lg tracking-[0.5em]" placeholder="000000" maxlength="6">
                    <button id="verifyOtpBtn" onclick="verifyAdminOTP()" class="w-full bg-emerald-500 text-black font-bold py-3 rounded-lg">UNLOCK</button>
                </div>
            </div>
            <div id="recaptcha-container"></div>
        </div>
    </div>

    <aside class="sidebar">
        <div class="flex items-center gap-3 mb-8 px-2">
            <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white font-bold">S</div>
            <span class="font-bold tracking-tight text-sm">SAGAR OPS</span>
        </div>
        <nav class="space-y-1">
            <button onclick="showSection('leads')" class="w-full text-left px-3 py-2 rounded hover:bg-white/5 text-slate-400 hover:text-white text-sm font-medium flex items-center gap-3" id="d-leads"><i class="ri-inbox-line"></i> Leads</button>
            <button onclick="showSection('projects')" class="w-full text-left px-3 py-2 rounded hover:bg-white/5 text-slate-400 hover:text-white text-sm font-medium flex items-center gap-3" id="d-projects"><i class="ri-folder-2-line"></i> Projects</button>
            <button onclick="showSection('maproom')" class="w-full text-left px-3 py-2 rounded hover:bg-white/5 text-slate-400 hover:text-white text-sm font-medium flex items-center gap-3" id="d-maproom"><i class="ri-map-pin-line"></i> Zones</button>
        </nav>
    </aside>

    <main class="workspace">
        
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-xl font-bold text-white">Dashboard</h1>
                <p class="text-[10px] text-slate-500 font-mono" id="status-indicator">LIVE CONNECTION</p>
            </div>
            <div class="flex gap-2">
                <button onclick="showSection('create')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-500 transition">NEW RECORD</button>
                <button onclick="logout()" class="w-8 h-8 rounded-full bg-slate-800 text-red-400 flex items-center justify-center hover:bg-slate-700"><i class="ri-shut-down-line"></i></button>
            </div>
        </div>

        <div id="ceo-dashboard" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
            <div class="data-card p-4">
                <div class="text-[10px] text-slate-500 uppercase font-bold">Revenue</div>
                <div class="text-xl font-mono font-bold text-emerald-400 mt-1" id="stat-revenue">--</div>
            </div>
            <div class="data-card p-4">
                <div class="text-[10px] text-slate-500 uppercase font-bold">Drilled</div>
                <div class="text-xl font-mono font-bold text-blue-400 mt-1" id="stat-depth">--</div>
            </div>
        </div>

        <div id="filter-bar" class="mb-6 hidden">
            <input type="text" id="searchInput" onkeyup="filterData()" class="pro-input bg-zinc-900 border-zinc-800" placeholder="Search database...">
        </div>

        <div id="section-leads" class="content-section">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" id="leads-list"></div>
        </div>

        <div id="section-projects" class="content-section hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" id="projects-list"></div>
        </div>

        <div id="section-silent" class="content-section hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="silent-list"></div>
        </div>

        <div id="section-maproom" class="content-section hidden h-[80vh] flex flex-col md:flex-row gap-4">
            <div class="w-full md:w-72 flex flex-col bg-zinc-900 p-3 rounded-xl border border-zinc-800 h-[40vh] md:h-full order-2 md:order-1">
                <input type="text" id="zoneSearch" onkeyup="filterMapList()" class="pro-input mb-2" placeholder="Filter Zones...">
                <div class="flex-1 overflow-y-auto space-y-1 pr-1" id="zonesListSide"></div>
            </div>
            <div class="flex-1 relative rounded-xl overflow-hidden border border-zinc-800 order-1 md:order-2 h-full">
                <div id="adminMap" class="w-full h-full bg-zinc-800"></div>
                <div class="absolute top-4 right-4 flex flex-col gap-2">
                    <button onclick="setDrawMode('rock')" class="w-9 h-9 bg-red-900/80 text-red-400 rounded-lg flex items-center justify-center border border-red-500/50"><i class="ri-record-circle-line"></i></button>
                    <button onclick="setDrawMode('water')" class="w-9 h-9 bg-emerald-900/80 text-emerald-400 rounded-lg flex items-center justify-center border border-emerald-500/50"><i class="ri-drop-line"></i></button>
                    <button onclick="cancelDrawing()" id="btnCancelDraw" class="hidden w-9 h-9 bg-slate-800 text-white rounded-lg flex items-center justify-center"><i class="ri-close-line"></i></button>
                </div>
                <div id="saveZonePanel" class="absolute bottom-4 left-4 right-4 bg-black/80 backdrop-blur p-2 rounded-lg border border-slate-700 hidden flex gap-2">
                    <input type="hidden" id="drawType">
                    <input type="text" id="newZoneName" class="pro-input py-2" placeholder="Zone Name">
                    <button onclick="saveCurrentZone()" class="bg-blue-600 text-white px-4 rounded-lg text-xs font-bold">SAVE</button>
                </div>
            </div>
        </div>

        <div id="section-create" class="content-section hidden">
            <div class="max-w-xl mx-auto bg-zinc-900 p-6 rounded-xl border border-zinc-800">
                <h2 class="text-white font-bold mb-6 flex justify-between items-center">New Project <i onclick="showSection('projects')" class="ri-close-line text-slate-500 cursor-pointer"></i></h2>
                <form id="projectForm" onsubmit="saveProject(event)" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="p_id" class="pro-input text-slate-500 bg-black" readonly>
                        <input type="date" id="p_date" class="pro-input" required>
                    </div>
                    <input type="tel" id="p_mobile" class="pro-input" placeholder="Mobile Number" required maxlength="10">
                    <input type="text" id="p_name" class="pro-input" placeholder="Customer Name" required>
                    <input type="text" id="p_loc" class="pro-input" placeholder="Location" required>
                    <div class="flex gap-2">
                        <input type="text" id="p_gps" class="pro-input" placeholder="GPS" required>
                        <button type="button" onclick="openMapPicker()" class="bg-slate-800 px-3 rounded-lg text-white"><i class="ri-map-pin-line"></i></button>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <input type="number" id="p_depth" class="pro-input" placeholder="Depth (ft)">
                        <input type="text" id="p_yield" class="pro-input" placeholder="Yield">
                        <input type="number" id="p_casing" class="pro-input" placeholder="Casing">
                    </div>
                    <select id="p_casingType" class="pro-input"><option>PVC</option><option>MS</option></select>
                    <input type="hidden" id="p_rig" value="Sensor Rig"><input type="hidden" id="p_motor" value="7.5 HP Texmo">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-500">SAVE RECORD</button>
                </form>
            </div>
        </div>

    </main>

    <nav class="nav-dock">
        <div class="dock-icon active" id="nav-leads" onclick="showSection('leads')"><i class="ri-inbox-fill"></i></div>
        <div class="dock-icon" id="nav-projects" onclick="showSection('projects')"><i class="ri-folder-5-fill"></i></div>
        <div class="dock-icon" id="nav-silent" onclick="showSection('silent')"><i class="ri-eye-fill"></i></div>
        <div class="dock-icon" id="nav-maproom" onclick="showSection('maproom')"><i class="ri-map-pin-range-fill"></i></div>
    </nav>

    <div id="detailModal" class="modal">
        <div class="modal-box relative" id="modalContent">
            </div>
    </div>

    <div id="previewModal" class="modal">
        <div class="bg-white w-full max-w-2xl h-[85vh] rounded-xl flex flex-col overflow-hidden">
            <div class="p-3 border-b flex justify-between items-center bg-gray-50">
                <span class="text-xs font-bold text-gray-500 uppercase">Document Preview</span>
                <div class="flex gap-2">
                    <button onclick="confirmDownloadPDF()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold">Download</button>
                    <button onclick="document.getElementById('previewModal').classList.remove('open')" class="text-gray-400 hover:text-black"><i class="ri-close-line text-lg"></i></button>
                </div>
            </div>
            <div id="previewContent" class="flex-1 overflow-y-auto bg-gray-200 p-4"></div>
        </div>
    </div>

    <div id="mapModal" class="modal">
        <div class="bg-zinc-900 w-full h-[60vh] rounded-xl flex flex-col overflow-hidden border border-zinc-800">
            <div id="mapContainer" class="flex-1"></div>
            <button onclick="confirmLocation()" class="bg-blue-600 text-white py-3 font-bold text-sm tracking-widest">CONFIRM LOCATION</button>
        </div>
    </div>

    <script>
        if(CONTACT_INFO.firebase_config) firebase.initializeApp(CONTACT_INFO.firebase_config);
        const db = firebase.firestore();
        const auth = firebase.auth();

        function notify(msg, type='success') {
            Toastify({ text: msg, duration: 2000, gravity: "bottom", position: "center", style: { background: type==='success' ? "#27272a" : "#ef4444", color: "white", borderRadius: "50px", border: "1px solid #3f3f46", fontSize: "12px", fontWeight: "600", padding: "10px 20px" } }).showToast();
        }

        // --- AUTH ---
        auth.onAuthStateChanged(user => {
            const loginModal = document.getElementById('login-overlay');
            const initScreen = document.getElementById('init-screen');
            if(user) {
                db.collection('admins').doc(user.phoneNumber).get().then(doc => {
                    if (doc.exists) {
                        initScreen.style.display = 'none'; loginModal.classList.add('hidden');
                        showSection('leads'); loadAnalytics(); 
                    } else { notify("Access Denied", "error"); auth.signOut(); initScreen.style.display = 'none'; loginModal.classList.remove('hidden'); }
                }).catch(e => { notify("Connection Error", "error"); initScreen.style.display = 'none'; loginModal.classList.remove('hidden'); });
            } else { initScreen.style.display = 'none'; loginModal.classList.remove('hidden'); }
        });

        function sendAdminOTP() {
            const phone = document.getElementById('adminPhone').value;
            if(phone.length !== 10) return notify("Enter Valid Number", "error");
            const btn = document.getElementById('sendOtpBtn'); btn.innerText = "...";
            if(!window.recaptchaVerifier) window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {'size': 'invisible'});
            auth.signInWithPhoneNumber('+91'+phone, window.recaptchaVerifier).then(cr => {
                window.confirmationResult = cr; btn.classList.add('hidden');
                document.getElementById('otp-group').classList.remove('hidden');
            }).catch(e => { notify("SMS Failed", "error"); btn.innerText = "RETRY"; });
        }
        function verifyAdminOTP() { window.confirmationResult.confirm(document.getElementById('adminOtp').value).catch(() => notify("Wrong Code", "error")); }
        function logout() { auth.signOut(); window.location.reload(); }

        // --- NAVIGATION ---
        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(e => e.classList.add('hidden'));
            document.getElementById('section-'+id).classList.remove('hidden');
            document.querySelectorAll('.dock-icon').forEach(e => e.classList.remove('active'));
            const navEl = document.getElementById('nav-'+id); if(navEl) navEl.classList.add('active');
            
            const filterBar = document.getElementById('filter-bar');
            const dashboard = document.getElementById('ceo-dashboard');
            
            if(id === 'leads' || id === 'projects') {
                filterBar.classList.remove('hidden'); dashboard.classList.remove('hidden');
            } else {
                filterBar.classList.add('hidden'); dashboard.classList.add('hidden');
            }

            if(id === 'leads') loadLeads(); 
            else if(id === 'projects') loadProjects();
            else if(id === 'silent') loadSilentLeads(); 
            else if(id === 'maproom') initAdminMap();
        }

        // --- DATA LOGIC ---
        let leadsCache = [], projectsCache = [];
        function filterData() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const list = document.getElementById('section-leads').classList.contains('hidden') ? projectsCache : leadsCache;
            const filtered = list.filter(item => (item.name + item.mobile + item.loc).toLowerCase().includes(term));
            if(list === leadsCache) renderLeads(filtered); else renderProjects(filtered);
        }

        function loadLeads() { 
            const list = document.getElementById('leads-list');
            list.innerHTML = '<div class="text-center text-slate-600 col-span-full mt-10 font-mono text-xs">SYNCING...</div>';
            db.collection('leads').orderBy('timestamp','desc').limit(50).get().then(snap => {
                leadsCache = []; snap.forEach(d => { let data = d.data(); data.docId = d.id; leadsCache.push(data); });
                renderLeads(leadsCache);
            });
        }
        function renderLeads(list) {
            const el = document.getElementById('leads-list'); el.innerHTML = "";
            list.forEach(data => { 
                el.innerHTML += `
                <div onclick="openLeadModal('${data.docId}')" class="data-card p-4 grid grid-cols-[1fr_auto] gap-4 items-center cursor-pointer hover:border-blue-600">
                    <div class="min-w-0">
                        <div class="text-white font-bold text-sm truncate">${data.name}</div>
                        <div class="text-slate-500 text-xs font-mono truncate mt-0.5">${data.loc}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-emerald-400 font-mono font-bold text-sm">â‚¹${parseInt(data.total).toLocaleString()}</div>
                        <div class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">${data.status||'PENDING'}</div>
                    </div>
                </div>`; 
            });
        }

        function loadProjects() {
            const list = document.getElementById('projects-list');
            list.innerHTML = '<div class="text-center text-slate-600 col-span-full mt-10 font-mono text-xs">LOADING...</div>';
            db.collection('projects').orderBy('timestamp','desc').limit(50).get().then(snap => {
                projectsCache = []; snap.forEach(d => { let data = d.data(); projectsCache.push(data); });
                renderProjects(projectsCache);
            });
        }
        function renderProjects(list) {
            const el = document.getElementById('projects-list'); el.innerHTML = "";
            list.forEach(d => {
                el.innerHTML += `
                <div onclick="openProjectModal('${d.projectId}')" class="data-card p-4 cursor-pointer hover:border-emerald-600">
                    <div class="flex justify-between items-start mb-2">
                        <div class="font-bold text-white text-sm truncate w-2/3">${d.location}</div>
                        <div class="text-[10px] text-emerald-500 border border-emerald-500/30 px-1.5 py-0.5 rounded font-mono">${d.projectId}</div>
                    </div>
                    <div class="text-slate-500 text-xs font-mono">${d.customerName}</div>
                </div>`;
            });
        }

        function loadSilentLeads() {
            const list = document.getElementById('silent-list');
            db.collection('silent_leads').orderBy('timestamp', 'desc').limit(50).get().then(snap => {
                list.innerHTML = "";
                if(snap.empty) { list.innerHTML = '<div class="text-center text-slate-600 col-span-full mt-10 text-xs">NO SILENT LEADS</div>'; return; }
                snap.forEach(doc => {
                    const d = doc.data();
                    list.innerHTML += `
                    <div class="data-card p-4 flex justify-between items-center">
                        <div>
                            <div class="text-yellow-500 font-mono font-bold text-sm">${d.mobile}</div>
                            <div class="text-slate-500 text-[10px] mt-1">${new Date(d.timestamp.toDate()).toLocaleString()}</div>
                        </div>
                        <div class="flex gap-2">
                            <a href="tel:${d.mobile}" class="w-8 h-8 rounded bg-white/5 text-green-400 flex items-center justify-center border border-white/10 hover:bg-green-600 hover:text-white"><i class="ri-phone-fill"></i></a>
                            <button onclick="deleteRecord('silent_leads', '${doc.id}')" class="w-8 h-8 rounded bg-white/5 text-red-400 flex items-center justify-center border border-white/10 hover:bg-red-600 hover:text-white"><i class="ri-delete-bin-line"></i></button>
                        </div>
                    </div>`;
                });
            });
        }

        // --- ðŸŸ¢ THE DATA CARD MODAL (Redesigned) ---
        function openLeadModal(docId) {
            const data = leadsCache.find(l => l.docId === docId); 
            const notes = data.adminNotes || "";
            const content = `
            <div class="relative">
                <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i class="ri-close-circle-fill text-2xl"></i></button>
                <div class="bg-gradient-to-br from-blue-900/40 to-slate-900 border-b border-white/5 p-6">
                    <h2 class="text-2xl font-bold text-white leading-none">${data.name}</h2>
                    <a href="tel:${data.mobile}" class="text-blue-400 font-mono text-sm mt-1 inline-block hover:text-blue-300">${data.mobile}</a>
                </div>
                
                <div class="p-5">
                    <div class="bg-black/40 border border-white/5 rounded-xl p-4 grid grid-cols-2 gap-4 mb-5">
                        <div class="col-span-2 border-b border-white/5 pb-3 mb-1">
                            <label class="text-[10px] text-slate-500 font-bold uppercase tracking-wider block mb-1">Location</label>
                            <div class="text-sm text-slate-200">${data.loc}</div>
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 font-bold uppercase tracking-wider block mb-1">Depth</label>
                            <div class="text-lg text-white font-mono font-bold">${data.depth} <span class="text-xs text-slate-500">ft</span></div>
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 font-bold uppercase tracking-wider block mb-1">Estimate</label>
                            <div class="text-lg text-emerald-400 font-mono font-bold">â‚¹${parseInt(data.total).toLocaleString()}</div>
                        </div>
                    </div>

                    <div class="space-y-3 mb-6">
                        <div class="grid grid-cols-[1fr_auto] gap-2">
                            <select class="pro-input bg-zinc-900" onchange="updateLeadStatus('${data.docId}', this.value)">
                                <option ${data.status==='Pending'?'selected':''}>Pending</option>
                                <option ${data.status==='Contacted'?'selected':''}>Contacted</option>
                                <option ${data.status==='Site Visit'?'selected':''}>Site Visit</option>
                                <option ${data.status==='Closed'?'selected':''}>Closed</option>
                            </select>
                            <button onclick="saveNote('${data.docId}')" class="bg-zinc-800 text-blue-400 px-3 rounded-lg border border-zinc-700"><i class="ri-save-3-line"></i></button>
                        </div>
                        <textarea id="adminNotes" class="pro-input bg-zinc-900 h-20 resize-none" placeholder="Enter notes...">${notes}</textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <a href="https://wa.me/${data.mobile.replace('+','')}" target="_blank" class="flex items-center justify-center gap-2 bg-emerald-600/10 text-emerald-400 border border-emerald-600/20 py-3 rounded-lg hover:bg-emerald-600 hover:text-white transition font-bold text-xs uppercase"><i class="ri-whatsapp-line text-lg"></i> Chat</a>
                        <a href="tel:${data.mobile}" class="flex items-center justify-center gap-2 bg-blue-600/10 text-blue-400 border border-blue-600/20 py-3 rounded-lg hover:bg-blue-600 hover:text-white transition font-bold text-xs uppercase"><i class="ri-phone-line text-lg"></i> Call</a>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="previewQuote('${encodeURIComponent(JSON.stringify(data))}')" class="bg-zinc-800 text-zinc-300 py-3 rounded-lg hover:bg-zinc-700 transition font-bold text-xs uppercase">View PDF</button>
                        <button onclick="convertToProject('${data.docId}')" class="bg-purple-600/10 text-purple-400 border border-purple-600/20 py-3 rounded-lg hover:bg-purple-600 hover:text-white transition font-bold text-xs uppercase">Convert</button>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <button onclick="deleteRecord('leads', '${data.docId}')" class="text-red-500/40 text-[10px] font-bold tracking-widest uppercase hover:text-red-500">Delete Record</button>
                    </div>
                </div>
            `;
            document.getElementById('modalContent').innerHTML = content; document.getElementById('detailModal').classList.add('open');
        }

        function openProjectModal(id) { 
            db.collection('projects').doc(id).get().then(doc => { 
                const data = doc.data(); 
                const content = `
                <div class="relative">
                    <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i class="ri-close-circle-fill text-2xl"></i></button>
                    <div class="bg-zinc-900 border-b border-white/5 p-6">
                        <div class="text-[10px] text-emerald-500 font-bold uppercase tracking-widest mb-1">Project File</div>
                        <h2 class="text-xl font-bold text-white">${data.customerName}</h2>
                        <p class="text-slate-500 text-xs font-mono mt-1">${data.projectId}</p>
                    </div>
                    <div class="p-6">
                        <div class="bg-black/40 border border-white/5 rounded-xl p-4 grid grid-cols-2 gap-4 mb-6">
                            <div><label class="text-[10px] text-slate-500 font-bold uppercase">Depth</label><div class="text-white font-mono">${data.depth} ft</div></div>
                            <div><label class="text-[10px] text-slate-500 font-bold uppercase">Yield</label><div class="text-white font-mono">${data.yield}</div></div>
                            <div><label class="text-[10px] text-slate-500 font-bold uppercase">Casing</label><div class="text-white font-mono">${data.casing_depth} ft</div></div>
                            <div><label class="text-[10px] text-slate-500 font-bold uppercase">Motor</label><div class="text-white font-mono">${data.motor}</div></div>
                        </div>
                        <button onclick="previewCert('${encodeURIComponent(JSON.stringify(data))}')" class="w-full bg-emerald-600 text-white py-3 rounded-lg font-bold text-sm shadow-lg shadow-emerald-900/20 mb-3">VIEW CERTIFICATE</button>
                        <div class="flex gap-2">
                            <button onclick="editProject('${data.projectId}')" class="flex-1 bg-zinc-800 text-zinc-400 py-3 rounded-lg font-bold text-xs">EDIT</button>
                            <button onclick="deleteRecord('projects', '${data.projectId}')" class="flex-1 bg-red-900/10 text-red-500 py-3 rounded-lg font-bold text-xs border border-red-900/20">DELETE</button>
                        </div>
                    </div>
                </div>`;
                document.getElementById('modalContent').innerHTML = content; document.getElementById('detailModal').classList.add('open'); 
            }); 
        }

        // --- MAPS ---
        let adminMap, drawingManager, currentPoly; let mapPolygons = []; 
        let allZonesCache = [];
        const ZONE_CONFIG = { rock: { color: '#ef4444', label: 'Hard Rock' }, water: { color: '#10b981', label: 'High Yield' }, moderate: { color: '#eab308', label: 'Moderate' }, saline: { color: '#3b82f6', label: 'Saline' }, silt: { color: '#f97316', label: 'Loose Silt' } };

        function initAdminMap() {
            if(adminMap) { loadAdminZones(); return; }
            adminMap = new google.maps.Map(document.getElementById('adminMap'), { center: { lat: 16.4410, lng: 80.5520 }, zoom: 13, mapTypeId: 'hybrid', disableDefaultUI: true });
            drawingManager = new google.maps.drawing.DrawingManager({ drawingMode: null, drawingControl: false, polygonOptions: { strokeWeight: 2, fillOpacity: 0.35, editable: true, draggable: false } });
            drawingManager.setMap(adminMap);
            google.maps.event.addListener(drawingManager, 'polygoncomplete', function(poly) { if(currentPoly) discardCurrentZone(); currentPoly = poly; document.getElementById('saveZonePanel').classList.remove('hidden'); document.getElementById('btnCancelDraw').classList.add('hidden'); drawingManager.setDrawingMode(null); });
            loadAdminZones();
        }
        function loadAdminZones() {
            const list = document.getElementById('zonesListSide'); 
            if(allZonesCache.length === 0) {
                list.innerHTML = '<div class="text-center text-slate-500 text-xs mt-4">SYNCING ATLAS...</div>';
                db.collection('geo_zones').get().then(snap => {
                    allZonesCache = [];
                    snap.forEach(doc => { allZonesCache.push({ id: doc.id, ...doc.data() }); });
                    renderMapList(allZonesCache); renderMapPolygons(allZonesCache);
                });
            } else { renderMapList(allZonesCache); }
        }
        function filterMapList() { const term = document.getElementById('zoneSearch').value.toLowerCase(); renderMapList(allZonesCache.filter(z => z.name.toLowerCase().includes(term))); }
        function renderMapList(zones) {
            const list = document.getElementById('zonesListSide'); list.innerHTML = "";
            zones.slice(0, 50).forEach(z => {
                list.innerHTML += `<div onclick="focusZone('${z.id}')" class="p-2 border-b border-zinc-800 cursor-pointer hover:bg-zinc-800 flex justify-between items-center group"><div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full" style="background:${z.color}"></div><span class="text-xs text-zinc-300 font-bold group-hover:text-white">${z.name}</span></div><button onclick="event.stopPropagation(); deleteZone('${z.id}')" class="text-zinc-600 hover:text-red-500"><i class="ri-close-line"></i></button></div>`;
            });
        }
        function renderMapPolygons(zones) {
            if(mapPolygons) mapPolygons.forEach(p => p.setMap(null)); mapPolygons = [];
            zones.forEach(z => {
                const poly = new google.maps.Polygon({ paths: z.coords, strokeColor: z.color, fillColor: z.color, fillOpacity: 0.15, strokeWeight: 1, map: adminMap });
                poly.addListener('click', () => { new google.maps.InfoWindow({ content: `<div style="color:black;font-weight:bold">${z.name}</div><button onclick="deleteZone('${z.id}')" style="color:red;font-size:10px">DELETE</button>` }).open(adminMap, poly); });
                mapPolygons.push(poly);
            });
        }
        function focusZone(id) { const zone = allZonesCache.find(z => z.id === id); if(zone) { let b = new google.maps.LatLngBounds(); zone.coords.forEach(c => b.extend(c)); adminMap.fitBounds(b); } }
        function setDrawMode(type) { discardCurrentZone(); document.getElementById('drawType').value = type; drawingManager.setOptions({ drawingMode: google.maps.drawing.OverlayType.POLYGON, polygonOptions: { fillColor: ZONE_CONFIG[type].color, strokeColor: ZONE_CONFIG[type].color, fillOpacity: 0.35, strokeWeight: 2, editable: true } }); document.getElementById('btnCancelDraw').classList.remove('hidden'); notify(`Draw: ${ZONE_CONFIG[type].label}`); }
        function cancelDrawing() { drawingManager.setDrawingMode(null); document.getElementById('btnCancelDraw').classList.add('hidden'); discardCurrentZone(); }
        function discardCurrentZone() { document.getElementById('saveZonePanel').classList.add('hidden'); if(currentPoly) { currentPoly.setMap(null); currentPoly = null; } }
        function saveCurrentZone() {
            const name = document.getElementById('newZoneName').value; const type = document.getElementById('drawType').value;
            if(!name) return notify("Enter Name", "error");
            const path = currentPoly.getPath(); let coords = []; for(let i=0; i<path.getLength(); i++) { coords.push({ lat: path.getAt(i).lat(), lng: path.getAt(i).lng() }); }
            db.collection('geo_zones').doc(name.replace(/\s+/g, '_').toLowerCase()).set({ name, type, color: ZONE_CONFIG[type].color, coords, timestamp: firebase.firestore.FieldValue.serverTimestamp() }).then(() => { notify("Saved"); discardCurrentZone(); loadAdminZones(); });
        }
        function deleteZone(id) { if(confirm("Delete?")) db.collection('geo_zones').doc(id).delete().then(() => { notify("Deleted"); allZonesCache = allZonesCache.filter(z => z.id !== id); loadAdminZones(); }); }

        // --- UTILS ---
        function updateLeadStatus(docId, status) { db.collection('leads').doc(docId).update({ status: status }).then(() => notify("Updated")); }
        function saveNote(docId) { db.collection('leads').doc(docId).update({ adminNotes: document.getElementById('adminNotes').value }).then(() => notify("Note Saved")); }
        function convertToProject(docId) {
            const lead = leadsCache.find(l => l.docId === docId); closeModal(); showSection('create'); resetForm();
            document.getElementById('p_mobile').value = lead.mobile.replace('+91', ''); document.getElementById('p_name').value = lead.name; document.getElementById('p_loc').value = lead.loc; document.getElementById('p_depth').value = lead.depth; notify("Lead Imported");
        }
        function resetForm() { document.getElementById('projectForm').reset(); const now = new Date(); const yy = now.getFullYear().toString().substr(-2); const mm = (now.getMonth() + 1).toString().padStart(2, '0'); document.getElementById('p_id').value = `SBW-${yy}${mm}-${Math.random().toString(36).substr(2, 4).toUpperCase()}`; }
        function deleteRecord(col, id) { if(confirm("Delete?")) db.collection(col).doc(id).delete().then(() => { notify("Deleted"); closeModal(); if(col==='leads') loadLeads(); else if(col==='projects') loadProjects(); else loadSilentLeads(); }); }
        function closeModal() { document.getElementById('detailModal').classList.remove('open'); }
        function loadAnalytics() { db.collection('leads').get().then(s => { let rev=0; s.forEach(d=> rev+=parseInt(d.data().total||0)); document.getElementById('stat-revenue').innerText = "â‚¹" + (rev/100000).toFixed(1) + "L"; }); db.collection('projects').get().then(s => { let d=0; s.forEach(doc=> d+=parseInt(doc.data().depth||0)); document.getElementById('stat-depth').innerText = d.toLocaleString() + " ft"; }); }
        function previewQuote(encoded) { const data = JSON.parse(decodeURIComponent(encoded)); let rows = `<tr><td>Estimate based on ${data.depth}ft</td><td style="text-align:right">â‚¹${parseInt(data.total).toLocaleString()}</td></tr>`; const content = getInvoiceHTML({ id: data.docId, name: data.name, mobile: data.mobile, loc: data.loc, total: data.total, rows: rows }); document.getElementById('previewContent').innerHTML = content; currentPDFElement = content; document.getElementById('previewModal').classList.add('open'); }
        function previewCert(encoded) { const data = JSON.parse(decodeURIComponent(encoded)); const certData = { id: data.projectId, name: data.customerName, loc: data.location, date: data.date, gps: data.gps, depth: data.depth, casing_depth: data.casing_depth, casing_type: data.casing_type, yield: data.yield, motor: data.motor, rigType: data.rigType }; const content = getCertificateHTML(certData); document.getElementById('previewContent').innerHTML = content; currentPDFElement = content; document.getElementById('previewModal').classList.add('open'); }
        function confirmDownloadPDF() { const el = document.createElement('div'); el.innerHTML = currentPDFElement; document.body.appendChild(el); html2pdf().from(el).save('Document.pdf').then(() => document.body.removeChild(el)); }
        function editProject(id) { const data = projectsCache.find(p => p.projectId === id); closeModal(); showSection('create'); document.getElementById('p_id').value = data.projectId; document.getElementById('p_mobile').value = data.mobile.replace('+91',''); document.getElementById('p_name').value = data.customerName; document.getElementById('p_loc').value = data.location; document.getElementById('p_gps').value = data.gps; document.getElementById('p_depth').value = data.depth; document.getElementById('p_yield').value = data.yield; document.getElementById('p_casing').value = data.casing_depth; document.getElementById('p_casingType').value = data.casing_type; document.getElementById('p_date').value = data.date; }
        function saveProject(e) { e.preventDefault(); const id = document.getElementById('p_id').value; const data = { projectId: id, mobile: "+91" + document.getElementById('p_mobile').value, customerName: document.getElementById('p_name').value, location: document.getElementById('p_loc').value, gps: document.getElementById('p_gps').value, depth: document.getElementById('p_depth').value, yield: document.getElementById('p_yield').value, casing_depth: document.getElementById('p_casing').value, casing_type: document.getElementById('p_casingType').value, rigType: document.getElementById('p_rig').value, motor: document.getElementById('p_motor').value, date: document.getElementById('p_date').value, timestamp: firebase.firestore.FieldValue.serverTimestamp() }; db.collection('projects').doc(id).set(data, { merge: true }).then(() => { notify("Saved"); resetForm(); showSection('projects'); }); }
        
        function initMapTools() { const input = document.getElementById('p_loc'); if(input) { const ac = new google.maps.places.Autocomplete(input); ac.addListener('place_changed', () => { const p = ac.getPlace(); if(p.geometry && map) map.setCenter(p.geometry.location); }); } }
        function openMapPicker() { if(typeof google === 'undefined') { notify("Maps Loading...", "error"); return; } document.getElementById('mapModal').classList.add('open'); setTimeout(() => { if(!window.pMap) window.pMap = new google.maps.Map(document.getElementById('mapContainer'), { center: {lat: 16.44, lng: 80.55}, zoom: 16, disableDefaultUI: true }); google.maps.event.trigger(window.pMap, 'resize'); }, 200); }
        function confirmLocation() { const c = window.pMap.getCenter(); document.getElementById('p_gps').value = `${c.lat().toFixed(6)}, ${c.lng().toFixed(6)}`; document.getElementById('mapModal').classList.remove('open'); }
        const s = document.createElement('script'); s.src = `https://maps.googleapis.com/maps/api/js?key=${CONTACT_INFO.google_maps_key}&libraries=places,drawing,geometry&callback=initMapTools`; s.async = true; s.defer = true; document.body.appendChild(s);
    </script>
</body>
</html>
