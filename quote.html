<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Quote | Sagar Borewells</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/layout.js"></script>
    <script src="assets/js/pdf_template.js"></script>

    <style>
        /* CORE STYLES */
        :root { --primary: #0f172a; --accent: #2563eb; --bg: #f8fafc; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: #334155; }
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .quote-card { background: #ffffff; border-radius: 20px; box-shadow: 0 10px 40px -10px rgba(0,0,0,0.05); padding: 40px; max-width: 800px; margin: 40px auto; border: 1px solid #e2e8f0; }
        .form-label { font-weight: 700; font-size: 0.75rem; text-transform: uppercase; color: #64748b; margin-bottom: 6px; display: block; letter-spacing: 0.5px; }
        .custom-input, .custom-select { width: 100%; padding: 14px; border: 1px solid #cbd5e1; border-radius: 10px; font-weight: 600; font-size: 0.95rem; color: #1e293b; background: #fff; transition: 0.2s; }
        .custom-input:focus { border-color: var(--accent); ring: 2px solid var(--accent); }
        
        .btn-primary { background: var(--primary); color: white; font-weight: 700; padding: 18px; border-radius: 12px; width: 100%; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; }
        .btn-primary:hover { background: #1e293b; }
        .btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; }

        /* GO-TORQ STYLE TABLE */
        .est-table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 0.9rem; }
        .est-table th { background: #f1f5f9; text-align: left; padding: 12px; color: #475569; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; border-bottom: 2px solid #e2e8f0; }
        .est-table td { padding: 14px 12px; border-bottom: 1px solid #f1f5f9; font-weight: 600; color: #334155; }
        .est-table tr:last-child td { border-bottom: none; }
        .row-subtotal td { border-top: 2px solid #e2e8f0; font-weight: 800; color: #0f172a; background: #f8fafc; }

        /* VARIABLE MATERIALS BADGE GRID */
        .est-var-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .var-item-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; padding: 6px 0; border-bottom: 1px dashed #e2e8f0; }
        .var-badge { background: #eff6ff; color: #2563eb; font-weight: 700; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; }

        /* SLIDER */
        .slider-container { background: #f8fafc; border-radius: 16px; padding: 30px; text-align: center; border: 1px solid #e2e8f0; }
        .range-slider { width: 100%; height: 12px; border-radius: 6px; background: #e2e8f0; outline: none; -webkit-appearance: none; }
        .range-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 32px; height: 32px; border-radius: 50%; background: var(--accent); border: 4px solid #fff; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4); cursor: pointer; }

        /* MAPS */
        .pac-container { border-radius: 12px; margin-top: 5px; border: 0; box-shadow: 0 10px 25px rgba(0,0,0,0.1); font-family: 'Plus Jakarta Sans', sans-serif; }
        .pac-item { padding: 12px; border-top: 1px solid #f1f5f9; font-size: 13px; color: #64748b; }
        .pac-item:hover { background: #f8fafc; }
        .pac-icon { display: none; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="navbar-mount"></div>

    <main class="flex-grow">
        <div id="step-1" class="container mx-auto px-4 fade-in-up">
            <div class="quote-card">
                <div class="text-center mb-10">
                    <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight mb-2">Estimate Calculator</h1>
                    <p class="text-slate-500 text-sm">Zone-Specific Drilling Rates â€¢ Transparent Pricing</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="form-label">Full Name</label>
                        <input type="text" id="custName" class="custom-input" placeholder="Your Name">
                    </div>
                    <div>
                        <label class="form-label">Mobile Number</label>
                        <div class="relative">
                            <input type="tel" id="custMobile" class="custom-input pr-24" placeholder="98765 43210" maxlength="10">
                            <button id="sendOtpBtn" onclick="sendOTP()" class="absolute right-2 top-2 bottom-2 bg-slate-900 text-white px-4 rounded-lg font-bold text-xs">VERIFY</button>
                            <div id="verifiedBadge" class="absolute right-4 top-4 text-emerald-600 text-xs font-bold uppercase hidden"><i class="ri-checkbox-circle-fill"></i> Verified</div>
                        </div>
                        <div id="otpSection" class="hidden mt-2 gap-2">
                            <input type="text" id="otpInput" class="custom-input text-center tracking-widest" placeholder="OTP" maxlength="6">
                            <button onclick="verifyOTP()" class="bg-emerald-600 text-white px-6 rounded-lg font-bold text-xs">OK</button>
                        </div>
                        <div id="recaptcha-container"></div>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="form-label">Site Location</label>
                    <div class="relative flex gap-2">
                        <input type="text" id="locInput" class="custom-input pr-24" placeholder="Search Village / Area...">
                        <button onclick="detectGPS()" class="absolute right-14 top-2 bottom-2 bg-blue-50 text-blue-600 px-3 rounded-lg font-bold text-xs hover:bg-blue-100">DETECT</button>
                        <button onclick="openMiniMap()" class="absolute right-2 top-2 bottom-2 bg-slate-100 text-slate-600 px-3 rounded-lg hover:bg-slate-200" title="Pick on Map"><i class="ri-map-pin-2-line"></i></button>
                    </div>
                    <p id="distDisplay" class="text-xs text-right mt-2 text-slate-400 font-mono"></p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <label class="form-label">Soil / Zone Type</label>
                        <select id="zoneInput" class="custom-select bg-blue-50 border-blue-200 text-blue-800">
                            <option value="" disabled selected>Loading Zones...</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Purpose</label>
                        <select id="purposeInput" class="custom-select">
                            <option value="residential">Residential</option>
                            <option value="agriculture">Agriculture / Farm</option>
                            <option value="commercial">Industrial</option>
                        </select>
                    </div>
                </div>

                <div class="mb-10">
                    <label class="form-label text-center mb-4">ESTIMATED DEPTH REQUIRED</label>
                    <div class="slider-container">
                        <div class="mb-2"><span id="display-val" class="text-6xl font-extrabold text-blue-600 tracking-tighter">100</span><span class="text-xl font-bold text-slate-400 align-top ml-1">FT</span></div>
                        <input type="range" id="depthSlider" class="range-slider" min="100" max="1500" value="100" step="10">
                        <div class="flex justify-between text-xs font-bold text-slate-400 mt-3"><span>100 FT</span><span id="maxLabel">1500 FT</span></div>
                    </div>
                </div>

                <button id="generateBtn" onclick="goToStep2()" class="btn-primary" disabled>
                    <i class="ri-calculator-line"></i> Calculate Estimate
                </button>
            </div>
        </div>

        <div id="step-2" class="container mx-auto px-4 fade-in-up hidden">
            <div class="quote-card p-0 overflow-hidden" id="invoice-capture">
                <div class="bg-slate-900 p-8 text-white">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-2xl font-bold tracking-tight">SAGAR BOREWELLS</h2>
                            <p class="text-xs text-slate-400 mt-1 uppercase tracking-widest">Quote Reference #WEB-EST</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-slate-400 font-bold uppercase mb-1">Estimated Total</p>
                            <div class="text-3xl font-extrabold text-white" id="invTotal">â‚¹0</div>
                        </div>
                    </div>
                    <div class="flex gap-6 mt-6 text-sm text-slate-300 font-mono text-xs">
                        <div><span class="text-slate-500 block uppercase font-bold text-[10px]">Location</span> <span id="invLoc">--</span></div>
                        <div><span class="text-slate-500 block uppercase font-bold text-[10px]">Zone</span> <span id="invZone">--</span></div>
                        <div><span class="text-slate-500 block uppercase font-bold text-[10px]">Depth</span> <span id="invDepth">--</span></div>
                    </div>
                </div>

                <div class="p-8">
                    
                    <div class="mb-8">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="ri-bar-chart-grouped-line text-blue-600"></i>
                            <h4 class="text-sm font-bold text-slate-800 uppercase">Drilling Cost Structure</h4>
                        </div>
                        <table class="est-table">
                            <thead><tr><th>Depth Range</th><th style="text-align:right;">Rate</th><th style="text-align:right;">Amount</th></tr></thead>
                            <tbody id="drillTableBody"></tbody>
                            <tfoot><tr class="row-subtotal"><td colspan="2">Drilling Subtotal</td><td style="text-align:right;" id="drillSubTotal">â‚¹0</td></tr></tfoot>
                        </table>
                    </div>

                    <div class="mb-8">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="ri-settings-4-line text-emerald-600"></i>
                            <h4 class="text-sm font-bold text-slate-800 uppercase">Fixed Operational Costs</h4>
                        </div>
                        <table class="est-table">
                            <tbody id="opsTableBody"></tbody>
                            <tfoot><tr class="row-subtotal"><td colspan="2">Ops Subtotal</td><td style="text-align:right;" id="opsSubTotal">â‚¹0</td></tr></tfoot>
                        </table>
                    </div>

                    <div class="bg-blue-50 border border-blue-100 rounded-xl p-5 relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-blue-200 text-blue-800 text-[10px] font-bold px-3 py-1 rounded-bl-lg">CHARGED ON ACTUALS</div>
                        <div class="flex items-start gap-3">
                            <i class="ri-information-fill text-xl text-blue-600 mt-1"></i>
                            <div class="w-full">
                                <h4 class="font-bold text-slate-800 text-sm uppercase mb-1">Variable Materials (Market Rate)</h4>
                                <p class="text-xs text-slate-500 mb-4">Material costs depend on the actual depth casing is inserted. These are current unit prices.</p>
                                <div class="est-var-grid" id="materialGrid">
                                    </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8 no-print">
                        <button onclick="goToStep1()" class="py-4 text-slate-500 font-bold border border-slate-200 rounded-xl hover:bg-slate-50 transition">Edit Details</button>
                        <button onclick="confirmBooking()" class="py-4 bg-slate-900 text-white font-bold rounded-xl hover:bg-black transition shadow-xl">Confirm & Book</button>
                    </div>
                    <p class="text-center text-[10px] text-slate-400 mt-4 uppercase font-bold tracking-wider">Valid for 30 Days â€¢ Computer Generated</p>
                </div>
            </div>
        </div>

        <div id="step-3" class="container mx-auto px-4 fade-in-up hidden">
            <div class="quote-card text-center">
                <div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="ri-check-line text-4xl"></i>
                </div>
                <h1 class="text-3xl font-extrabold text-slate-900 mb-2">Request Received!</h1>
                <p class="text-slate-500 mb-8 max-w-md mx-auto">We have saved your estimate. Our team will contact you shortly to finalize the site visit.</p>
                <div class="flex justify-center gap-4">
                    <a href="dashboard.html" class="py-3 px-8 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700">Go to Dashboard</a>
                </div>
            </div>
        </div>
    </main>

    <div id="footer-mount"></div>

    <div id="miniMapModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center;">
        <div class="bg-white p-4 rounded-xl w-full max-w-lg shadow-2xl">
            <h3 class="font-bold text-slate-800 mb-2 text-center">Pinpoint Location</h3>
            <div style="position: relative; width: 100%; height: 300px; background: #eee; border-radius: 10px; overflow: hidden;">
                <div id="quoteMapContainer" style="width:100%; height:100%;"></div>
                <div class="target-reticle">
                    <div class="reticle-dot"></div><div class="reticle-ring"></div>
                    <div class="absolute w-[60px] h-[1px] bg-blue-500/20"></div><div class="absolute h-[60px] w-[1px] bg-blue-500/20"></div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="document.getElementById('miniMapModal').style.display='none'" class="px-4 py-2 font-bold text-slate-500">Cancel</button>
                <button onclick="confirmQuoteLocation()" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg">Set Location</button>
            </div>
        </div>
    </div>

    <script>
        // INIT
        if(CONTACT_INFO.firebase_config && !firebase.apps.length) firebase.initializeApp(CONTACT_INFO.firebase_config);
        const db = firebase.firestore();

        // ðŸŸ¢ GLOBAL CONFIG
        const OFFICE_COORDS = { lat: 16.4410, lng: 80.5520 }; // Mangalagiri
        let transportDist = 0;
        let siteCoords = null;
        let globalRates = { base_rate: 90, slab_step: 10, flushing: 8000, slotting: 200, transport: 1000 };
        let inventory = [];

        // 1. DATA LOAD
        document.addEventListener("DOMContentLoaded", async () => {
            // A. Settings
            const ratesDoc = await db.collection('settings').doc('rates').get();
            if(ratesDoc.exists) globalRates = { ...globalRates, ...ratesDoc.data() };

            // B. Zones
            const zoneSnap = await db.collection('zones').get();
            const zoneSelect = document.getElementById('zoneInput');
            zoneSelect.innerHTML = '<option value="" disabled selected>Select Soil Type / Zone</option>';
            zoneSnap.forEach(doc => {
                const data = doc.data();
                const opt = document.createElement('option');
                opt.value = doc.id;
                opt.innerText = data.name;
                opt.dataset.rate = data.rate || globalRates.base_rate;
                zoneSelect.appendChild(opt);
            });

            // C. Inventory (For display only)
            const invSnap = await db.collection('inventory').where('type', '==', 'casing').get();
            if (!invSnap.empty) {
                invSnap.forEach(doc => inventory.push(doc.data()));
            } else {
                // Fallbacks
                inventory = [
                    { name: "10\" PVC Casing", price: 400 },
                    { name: "7\" MS Medium", price: 500 },
                    { name: "7\" MS Heavy", price: 650 }
                ];
            }
        });

        // 2. AUTH CHECK
        firebase.auth().onAuthStateChanged((user) => {
            const genBtn = document.getElementById('generateBtn');
            if (user) {
                document.getElementById('custMobile').value = user.phoneNumber.replace('+91', '');
                document.getElementById('custMobile').disabled = true;
                document.getElementById('sendOtpBtn').style.display = 'none';
                document.getElementById('otpSection').style.display = 'none';
                document.getElementById('verifiedBadge').classList.remove('hidden');
                genBtn.disabled = false;
                genBtn.classList.remove('bg-slate-300'); // Enable style
            } else { genBtn.disabled = true; }
        });

        // 3. MAPS
        let autocomplete;
        function initMapTools() {
            const input = document.getElementById('locInput');
            autocomplete = new google.maps.places.Autocomplete(input, { types: ['geocode'] });
            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (place.geometry) {
                    siteCoords = { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() };
                    calcDistance();
                }
            });
        }

        function calcDistance() {
            if(!siteCoords) return;
            const R = 6371; 
            const dLat = (siteCoords.lat - OFFICE_COORDS.lat) * Math.PI/180;
            const dLon = (siteCoords.lng - OFFICE_COORDS.lng) * Math.PI/180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(OFFICE_COORDS.lat*Math.PI/180) * Math.cos(siteCoords.lat*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            transportDist = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            const distDisp = document.getElementById('distDisplay');
            if(transportDist > 30) {
                distDisp.innerText = `Distance: ${transportDist.toFixed(1)} km (Transport Charges Apply)`;
                distDisp.classList.add('text-orange-500');
            } else {
                distDisp.innerText = `Distance: ${transportDist.toFixed(1)} km (Free Transport)`;
                distDisp.classList.remove('text-orange-500');
            }
        }

        // 4. SLIDER
        const slider = document.getElementById('depthSlider');
        slider.addEventListener('input', function() {
            document.getElementById('display-val').innerText = this.value;
            const pct = ((this.value - this.min) / (this.max - this.min)) * 100;
            this.style.background = `linear-gradient(to right, var(--accent) 0%, var(--accent) ${pct}%, #e2e8f0 ${pct}%, #e2e8f0 100%)`;
        });

        // 5. OTP (Standard)
        function sendOTP() {
            const phone = document.getElementById('custMobile').value;
            if (phone.length !== 10) return alert("Enter 10 digit number");
            const btn = document.getElementById('sendOtpBtn'); btn.innerText = "...";
            if(!window.recaptchaVerifier) window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {'size': 'invisible'});
            firebase.auth().signInWithPhoneNumber('+91' + phone, window.recaptchaVerifier).then((cr) => {
                window.confirmationResult = cr; btn.style.display = 'none'; document.getElementById('otpSection').classList.remove('hidden'); document.getElementById('otpSection').classList.add('flex');
            }).catch((e) => { console.error(e); alert("SMS Error"); btn.innerText="VERIFY"; });
        }
        function verifyOTP() {
            const code = document.getElementById('otpInput').value;
            window.confirmationResult.confirm(code).then(() => { document.getElementById('otpSection').style.display = 'none'; }).catch(() => alert("Invalid OTP"));
        }

        let leadData = {};

        // ðŸŸ¢ 6. CALCULATION ENGINE (Go-Torq Model)
        function goToStep2() {
            const name = document.getElementById('custName').value;
            const loc = document.getElementById('locInput').value;
            const zoneSelect = document.getElementById('zoneInput');
            if(!name || !loc || !zoneSelect.value) { alert("Please fill Name, Location and Zone"); return; }

            const totalDepth = parseInt(slider.value);
            const startRate = parseFloat(zoneSelect.options[zoneSelect.selectedIndex].dataset.rate) || globalRates.base_rate;
            const slabStep = globalRates.slab_step;

            // A. DRILLING (Slab)
            let drillingCost = 0, currentDepth = 0, currentSlabRate = startRate, drillRows = "";
            
            // Slab 1: 0-100ft (Base)
            const firstSlab = Math.min(totalDepth, 100);
            if(firstSlab > 0) {
                const cost = firstSlab * currentSlabRate;
                drillingCost += cost;
                drillRows += `<tr><td>0 - ${firstSlab} ft</td><td style="text-align:right;">â‚¹${currentSlabRate}</td><td style="text-align:right;">â‚¹${cost.toLocaleString()}</td></tr>`;
                currentDepth += firstSlab;
            }
            // Slab 2+: (+50ft)
            while(currentDepth < totalDepth) {
                currentSlabRate += slabStep;
                let nextChunk = Math.min(50, totalDepth - currentDepth);
                let cost = nextChunk * currentSlabRate;
                drillingCost += cost;
                drillRows += `<tr><td>${currentDepth} - ${currentDepth+nextChunk} ft</td><td style="text-align:right;">â‚¹${currentSlabRate}</td><td style="text-align:right;">â‚¹${cost.toLocaleString()}</td></tr>`;
                currentDepth += nextChunk;
            }

            // B. OPS
            const transport = (transportDist > 30) ? globalRates.transport : 0;
            const flushing = globalRates.flushing;
            const setting = 5000; // Estimated Setting Charge
            const opsTotal = transport + flushing + setting;
            
            const opsRows = `
                <tr><td>Setting Charges</td><td style="text-align:right;">-</td><td style="text-align:right;">â‚¹${setting.toLocaleString()}</td></tr>
                <tr><td>Transport & Labour</td><td style="text-align:right;">-</td><td style="text-align:right;">â‚¹${transport.toLocaleString()}</td></tr>
                <tr><td>Flushing</td><td style="text-align:right;">-</td><td style="text-align:right;">â‚¹${flushing.toLocaleString()}</td></tr>
            `;

            // C. RENDER
            document.getElementById('drillTableBody').innerHTML = drillRows;
            document.getElementById('drillSubTotal').innerText = "â‚¹" + drillingCost.toLocaleString();
            
            document.getElementById('opsTableBody').innerHTML = opsRows;
            document.getElementById('opsSubTotal').innerText = "â‚¹" + opsTotal.toLocaleString();
            
            const grandTotal = drillingCost + opsTotal;
            document.getElementById('invTotal').innerText = "â‚¹" + grandTotal.toLocaleString();
            
            // Meta Info
            document.getElementById('invLoc').innerText = loc;
            document.getElementById('invZone').innerText = zoneSelect.options[zoneSelect.selectedIndex].text;
            document.getElementById('invDepth').innerText = totalDepth + " ft";

            // D. VARIABLE MATERIAL GRID (Inventory)
            const matGrid = document.getElementById('materialGrid');
            matGrid.innerHTML = "";
            inventory.forEach(item => {
                matGrid.innerHTML += `
                    <div class="var-item-row">
                        <span class="font-bold text-slate-700">${item.name}</span> 
                        <span class="var-badge">â‚¹${item.price}/ft</span>
                    </div>`;
            });

            // Store Data
            leadData = { 
                name, mobile: "+91"+document.getElementById('custMobile').value, loc, 
                zone: zoneSelect.options[zoneSelect.selectedIndex].text, 
                depth: totalDepth, total: grandTotal, status: "Pending Review" 
            };

            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('step-2').classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function goToStep1() {
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById('step-1').classList.remove('hidden');
        }

        function confirmBooking() {
            const year = new Date().getFullYear();
            const rand = Math.floor(1000 + Math.random() * 9000);
            const leadId = `QT-${year}-${rand}`;
            const finalData = { ...leadData, id: leadId, timestamp: firebase.firestore.FieldValue.serverTimestamp(), userId: firebase.auth().currentUser.uid };
            db.collection('leads').doc(leadId).set(finalData).then(() => {
                document.getElementById('step-2').classList.add('hidden');
                document.getElementById('step-3').classList.remove('hidden');
            });
        }

        // MAPS
        let qMap;
        function openMiniMap() {
            if(typeof google === 'undefined') { alert("Map loading..."); return; } 
            document.getElementById('miniMapModal').style.display = 'flex';
            const center = {lat: 16.4410, lng: 80.5520}; 
            if(!qMap) qMap = new google.maps.Map(document.getElementById('quoteMapContainer'), { center: center, zoom: 15, disableDefaultUI: true });
            setTimeout(() => google.maps.event.trigger(qMap, 'resize'), 100);
        }
        function confirmQuoteLocation() {
            const pos = qMap.getCenter(); 
            siteCoords = { lat: pos.lat(), lng: pos.lng() }; 
            calcDistance(); 
            new google.maps.Geocoder().geocode({ location: pos }, (results, status) => {
                if(status === 'OK' && results[0]) {
                    document.getElementById('locInput').value = results[0].formatted_address;
                }
            });
            document.getElementById('miniMapModal').style.display = 'none';
        }
        function detectGPS() {
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    siteCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    calcDistance();
                    new google.maps.Geocoder().geocode({ location: siteCoords }, (res, status) => {
                        if(status === 'OK') document.getElementById('locInput').value = res[0].formatted_address;
                    });
                });
            }
        }

        const s = document.createElement('script'); 
        s.src = `https://maps.googleapis.com/maps/api/js?key=${CONTACT_INFO.google_maps_key}&libraries=places&callback=initMapTools`; 
        s.async = true; s.defer = true; 
        document.body.appendChild(s);
    </script>
</body>
</html>
