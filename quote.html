<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estimate Engine | Sagar Ops</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="assets/js/config.js"></script>
    <script src="assets/js/layout.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        .modal { opacity: 0; pointer-events: none; transition: all 0.3s ease; }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content { transform: translateY(20px); transition: transform 0.3s ease; }
        .modal.active .modal-content { transform: translateY(0); }
        #miniMap { height: 250px; width: 100%; border-radius: 8px; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="navbar-mount"></div>

    <main class="flex-grow p-4">
        <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-slate-50 p-6 border-b border-slate-200">
                <h1 class="text-xl font-bold text-slate-800">Project Details</h1>
                <p class="text-sm text-slate-500">Enter details to generate an official borewell estimate.</p>
            </div>
            
            <div class="p-6 md:p-8 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Name</label>
                        <input type="text" id="custName" class="w-full p-3 bg-white border border-slate-300 rounded-lg focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Mobile</label>
                        <input type="tel" id="custMobile" class="w-full p-3 bg-white border border-slate-300 rounded-lg focus:border-blue-500 outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Site Location</label>
                    <div class="flex gap-2">
                        <input type="text" id="locInput" placeholder="Village / Area Name" class="flex-grow p-3 bg-white border border-slate-300 rounded-lg focus:border-blue-500 outline-none">
                        
                        <button onclick="detectGPS()" class="px-4 bg-slate-100 hover:bg-slate-200 text-slate-600 border border-slate-300 rounded-lg" title="Use GPS">
                            <i class="fa-solid fa-location-crosshairs"></i>
                        </button>
                        
                        <button onclick="toggleMap()" class="px-4 bg-blue-100 hover:bg-blue-200 text-blue-600 border border-blue-200 rounded-lg" title="Pin on Map">
                            <i class="fa-solid fa-map-location-dot"></i>
                        </button>
                    </div>

                    <div id="mapContainer" class="hidden mt-3 relative border border-slate-300 rounded-lg overflow-hidden shadow-inner">
                        <div id="miniMap"></div>
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-red-600 text-3xl pointer-events-none drop-shadow-md pb-4">
                            <i class="fa-solid fa-location-dot"></i>
                        </div>
                        <div class="absolute bottom-3 left-1/2 -translate-x-1/2 z-10">
                            <button onclick="confirmMapPin()" class="bg-blue-600 text-white text-xs font-bold px-4 py-2 rounded-full shadow-lg">
                                Set This Location
                            </button>
                        </div>
                    </div>
                </div>

                <div class="p-5 bg-blue-50/50 rounded-xl border border-blue-100">
                    <div class="flex justify-between mb-2">
                        <label class="font-bold text-blue-900 text-sm">Target Depth</label>
                        <span class="font-bold text-blue-600"><span id="depthDisplay">500</span> ft</span>
                    </div>
                    <input type="range" id="depthSlider" min="100" max="1500" value="500" step="10" class="w-full h-2 bg-blue-200 rounded-lg accent-blue-600 cursor-pointer mb-6" oninput="updateUI()">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Usage Type</label>
                            <select id="purposeInput" class="w-full p-2 bg-white border border-slate-300 rounded-lg text-sm">
                                <option value="residential">Residential</option>
                                <option value="agriculture">Agriculture</option>
                                <option value="commercial">Commercial</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Casing Pipe</label>
                            <select id="casingType" class="w-full p-2 bg-white border border-slate-300 rounded-lg text-sm">
                                <option value="PVC">PVC (Standard)</option>
                                <option value="Heavy">PVC (Heavy)</option>
                                <option value="Iron">MS Iron</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button onclick="generatePreview()" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-600/20 transition">
                    Generate Official Estimate
                </button>
            </div>
        </div>
    </main>

    <div id="previewModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-slate-900/90 backdrop-blur-sm p-4">
        <div class="modal-content bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center">
                <span class="font-bold text-slate-700">Estimate Preview</span>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 font-bold text-sm">Edit <i class="fa-solid fa-pen ml-1"></i></button>
            </div>
            <div class="p-6 overflow-y-auto bg-slate-100 flex-grow">
                <div class="bg-white border border-slate-200 p-6 rounded-lg shadow-sm text-sm">
                    <div class="flex justify-between items-start mb-6 border-b border-slate-100 pb-4">
                        <div>
                            <h2 class="font-extrabold text-blue-700 text-lg">SAGAR BOREWELLS</h2>
                            <p class="text-slate-500 text-xs">Official Quote #PREVIEW</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] text-slate-400 font-bold uppercase">Estimated Total</p>
                            <p class="text-2xl font-bold text-slate-900" id="invTotal">‚Çπ0</p>
                        </div>
                    </div>
                    <div class="mb-4 text-xs text-slate-500">
                        <p><strong>Customer:</strong> <span id="invName">--</span></p>
                        <p><strong>Location:</strong> <span id="invLoc">--</span></p>
                    </div>
                    <table class="w-full mb-4 text-left border-collapse">
                        <thead>
                            <tr class="text-[10px] uppercase text-slate-400 border-b border-slate-100">
                                <th class="py-2">Description</th>
                                <th class="py-2 text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="invBody" class="text-slate-700 font-medium"></tbody>
                    </table>
                    <div class="flex justify-between border-t border-slate-100 pt-3 mt-2 font-bold text-slate-700">
                        <span>Fixed Costs (Transport/Setup)</span>
                        <span>‚Çπ7,000</span>
                    </div>
                    <div class="mt-4 p-3 bg-blue-50 text-blue-800 text-[10px] rounded border border-blue-100">
                        * Quote excludes GST & Casing Pipe costs. Final invoice based on actual depth drilled.
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white border-t border-slate-200">
                <button onclick="sendWhatsApp()" class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg flex justify-center items-center gap-2 shadow-lg">
                    <i class="fa-brands fa-whatsapp text-lg"></i> Confirm & Send Quote
                </button>
            </div>
        </div>
    </div>

    <div id="footer-mount"></div>

    <script>
        // CONFIG
        let pricingConfig = {
            fixed_cost: 7000,
            slab_size: 50,
            slab_jump: 5,
            rates: { 'residential': 90, 'agriculture': 85, 'commercial': 110 }
        };
        let leadData = {};
        
        // MAP VARIABLES
        let map, geocoder, marker;

        // FETCH LIVE PRICES
        document.addEventListener("DOMContentLoaded", () => {
            fetch(CONTACT_INFO.database_url + "?action=getSettings")
                .then(r => r.json())
                .then(data => {
                    if(data.fixed_cost) pricingConfig.fixed_cost = data.fixed_cost;
                    if(data.price_residential) pricingConfig.rates['residential'] = data.price_residential;
                }).catch(e => console.log("Using default prices"));
        });

        function updateUI() { document.getElementById('depthDisplay').innerText = document.getElementById('depthSlider').value; }

        // --- GPS LOGIC (Debug Version) ---
        function detectGPS() {
            const btn = document.querySelector('button[title="Use GPS"]');
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    
                    // Safety Check: Is Google Maps loaded?
                    if(typeof google === 'undefined' || typeof google.maps === 'undefined') {
                        alert("Maps not loaded yet. Please wait 2 seconds.");
                        btn.innerHTML = originalIcon;
                        return;
                    }

                    // 1. Initialize Geocoder
                    if(!geocoder) geocoder = new google.maps.Geocoder();
                    
                    // 2. Convert to Address
                    const latlng = { lat: parseFloat(lat), lng: parseFloat(lng) };
                    
                    geocoder.geocode({ location: latlng }, (results, status) => {
                        if (status === "OK" && results[0]) {
                            // SUCCESS: Show text address
                            document.getElementById('locInput').value = results[0].formatted_address;
                            btn.innerHTML = '<i class="fa-solid fa-check"></i>';
                        } else {
                            // FAILURE: Show error details
                            console.error("Geocode Error:", status);
                            if(status === 'REQUEST_DENIED') {
                                alert("Error: You must enable 'Geocoding API' in Google Cloud Console.");
                            } else {
                                alert("Address lookup failed: " + status);
                            }
                            
                            // Fallback to numbers
                            document.getElementById('locInput').value = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
                            btn.innerHTML = '<i class="fa-solid fa-location-dot"></i>';
                        }
                    });

                }, (err) => { 
                    console.warn(err);
                    alert('GPS Permission Denied. Please enable location.'); 
                    btn.innerHTML = originalIcon;
                });
            } else {
                alert("Browser does not support GPS");
                btn.innerHTML = originalIcon;
            }
        }

        // --- MAP LOGIC ---
        function toggleMap() {
            const container = document.getElementById('mapContainer');
            container.classList.toggle('hidden');
            
            if(!container.classList.contains('hidden') && !map) {
                initMap();
            }
        }

        function initMap() {
            if(window.google) {
                geocoder = new google.maps.Geocoder();
                const center = { lat: 16.4428, lng: 80.5645 }; // Default Mangalagiri
                
                map = new google.maps.Map(document.getElementById('miniMap'), {
                    center: center,
                    zoom: 15,
                    disableDefaultUI: true,
                    zoomControl: true
                });

                // Listen for Drag End to find address
                map.addListener('idle', () => {
                    const c = map.getCenter();
                    geocoder.geocode({ location: c }, (results, status) => {
                        if (status === "OK" && results[0]) {
                            document.getElementById('locInput').dataset.mapAddr = results[0].formatted_address;
                        }
                    });
                });
            }
        }

        function confirmMapPin() {
            const addr = document.getElementById('locInput').dataset.mapAddr;
            const c = map.getCenter();
            
            if(addr) {
                document.getElementById('locInput').value = addr;
            } else {
                document.getElementById('locInput').value = `${c.lat().toFixed(5)}, ${c.lng().toFixed(5)}`;
            }
            
            document.getElementById('mapContainer').classList.add('hidden');
        }

        // --- CALC LOGIC ---
        function generatePreview() {
            const name = document.getElementById('custName').value;
            const loc = document.getElementById('locInput').value;
            const depth = parseInt(document.getElementById('depthSlider').value);
            const purpose = document.getElementById('purposeInput').value;

            if(!name || !loc) { alert("Please enter Name and Location"); return; }

            let remaining = depth;
            let floor = 0;
            let rate = pricingConfig.rates[purpose];
            let drillTotal = 0;
            let rows = "";

            while(remaining > 0) {
                let chunk = (remaining >= pricingConfig.slab_size) ? pricingConfig.slab_size : remaining;
                let cost = chunk * rate;
                drillTotal += cost;
                rows += `<tr class="border-b border-slate-50"><td class="py-2">${floor}-${floor+chunk}ft @ ‚Çπ${rate}</td><td class="text-right">‚Çπ${cost.toLocaleString()}</td></tr>`;
                remaining -= chunk;
                floor += chunk;
                rate += pricingConfig.slab_jump;
            }

            const total = drillTotal + pricingConfig.fixed_cost;
            
            document.getElementById('invName').innerText = name;
            document.getElementById('invLoc').innerText = loc;
            document.getElementById('invBody').innerHTML = rows;
            document.getElementById('invTotal').innerText = "‚Çπ" + total.toLocaleString();

            leadData = { name, loc, depth, total, mobile: document.getElementById('custMobile').value };
            document.getElementById('previewModal').classList.add('active');
        }

        function closeModal() { document.getElementById('previewModal').classList.remove('active'); }

        function sendWhatsApp() {
            const formData = new FormData();
            formData.append("name", leadData.name);
            formData.append("mobile", leadData.mobile);
            formData.append("location", leadData.loc);
            formData.append("depth", leadData.depth);
            formData.append("price", leadData.total);
            formData.append("purpose", "Official Quote");

            fetch(CONTACT_INFO.database_url, { method: "POST", body: formData, mode: "no-cors" });

            const msg = `*OFFICIAL QUOTE REQUEST*%0A%0Aüë§ ${leadData.name}%0Aüìç ${leadData.loc}%0Aüìû ${leadData.mobile}%0A%0Aüìâ Depth: ${leadData.depth}ft%0Aüí∞ *Est. Total: ‚Çπ${leadData.total.toLocaleString()}*%0A%0A(Includes Fixed Costs). Please schedule site visit.`;
            window.open(`https://wa.me/${CONTACT_INFO.whatsapp_api}?text=${msg}`, '_blank');
        }
    </script>
    
    <script>
        const s = document.createElement('script');
        s.src = `https://maps.googleapis.com/maps/api/js?key=${CONTACT_INFO.google_maps_key}&libraries=places`;
        s.async = true; s.defer = true;
        document.body.appendChild(s);
    </script>
</body>
</html>
