<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Quote | Sagar Borewells</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/layout.js"></script>
    <script src="assets/js/quote_constants.js"></script> 
    <script src="assets/js/pdf_template.js"></script>

    <style>
        :root { --primary: #1e3a8a; --soil: #8d6e63; --rock: #78909c; --hard-rock: #455a64; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #1e293b; user-select: none; }
        
        /* DRILL SLIDER CONTAINER */
        .drill-stage {
            position: relative;
            height: 500px; /* Viewport for the drill */
            background: #e2e8f0;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
            margin: 20px 0;
            border: 2px solid #cbd5e1;
            display: flex;
            justify-content: center;
        }

        /* STRATA LAYERS (Background Visuals) */
        .strata-layer { position: absolute; width: 100%; left: 0; z-index: 0; opacity: 0.3; }
        .layer-top { top: 0; height: 20%; background: var(--soil); }
        .layer-mid { top: 20%; height: 40%; background: var(--rock); }
        .layer-bot { top: 60%; height: 40%; background: var(--hard-rock); }

        /* THE BOREHOLE (Trail) */
        .borehole-path {
            position: absolute;
            top: 0;
            width: 12px;
            background: #0f172a; /* Void color */
            left: 50%;
            transform: translateX(-50%);
            z-index: 1;
            border-radius: 0 0 6px 6px;
        }

        /* THE DRILL BIT (Thumb) */
        .drill-bit {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 60px;
            z-index: 10;
            cursor: grab;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
            touch-action: none; /* Crucial for mobile drag */
        }
        .drill-bit:active { cursor: grabbing; transform: translateX(-50%) scale(1.05); }

        /* BIT GRAPHIC (CSS Art) */
        .bit-head {
            width: 0; height: 0; 
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 30px solid #ef4444; /* Red Tip */
        }
        .bit-body {
            width: 24px; height: 30px; 
            background: linear-gradient(90deg, #334155 0%, #94a3b8 50%, #334155 100%);
            margin: 0 auto;
            border-radius: 0 0 4px 4px;
        }

        /* DEPTH RULER (Side Scale) */
        .depth-ruler {
            position: absolute;
            right: 10px;
            top: 0;
            bottom: 0;
            width: 60px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-family: monospace;
            font-size: 10px;
            color: #64748b;
            pointer-events: none;
            padding: 10px 0;
        }
        .ruler-mark { text-align: right; border-top: 1px solid #cbd5e1; width: 100%; padding-top: 2px; }

        /* HUD OVERLAY (Current Depth) */
        .drill-hud {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 16px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 20;
            border: 1px solid #e2e8f0;
        }

        /* EXPANSION NOTIFICATION */
        .expand-notify {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e3a8a;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            opacity: 0;
            transition: 0.3s;
            pointer-events: none;
            white-space: nowrap;
        }
        .expand-notify.active { opacity: 1; transform: translateX(-50%) translateY(-10px); }

        /* Standard Estimator Styles (Reused) */
        .est-card { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 50px -10px rgba(0,0,0,0.15); margin-top: 20px; border: 1px solid #e2e8f0; }
        .est-header { background: #ffffff; padding: 30px; border-bottom: 2px solid #1e3a8a; }
        .est-amount { font-size: 2.2rem; font-weight: 800; color: #1e3a8a; line-height: 1; margin-top: 5px; }
        .est-table { width: 100%; border-collapse: collapse; margin-bottom: 25px; font-size: 0.9rem; }
        .est-table th { text-align: left; padding: 8px; color: #64748b; font-size: 0.7rem; text-transform: uppercase; font-weight: 700; }
        .est-table td { padding: 10px 8px; border-bottom: 1px dashed #e2e8f0; font-weight: 600; color: #334155; }
        .est-table tfoot td { border-top: 2px solid #e2e8f0; font-weight: 800; color: #1e3a8a; padding-top: 15px; font-size: 1rem; border-bottom: none; }
        
        .var-box { background: #eff6ff; border: 1px dashed #bfdbfe; border-radius: 12px; padding: 20px; }
        .var-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 30px; font-size: 0.85rem; }
        .var-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px dashed #dbeafe; }
        .var-badge { background: #fff; color: #1e40af; font-size: 0.75rem; font-weight: 700; padding: 2px 8px; border-radius: 4px; border: 1px solid #bfdbfe; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="navbar-mount" style="min-height: 80px;"></div>

    <main class="flex-grow">
        
        <div id="step-1" class="container mx-auto px-4 py-8 max-w-2xl">
            <div class="bg-white rounded-3xl p-6 shadow-xl border border-slate-100">
                <div class="text-center mb-6">
                    <h1 class="text-2xl font-black text-slate-900 uppercase tracking-tight">Drill Configurator</h1>
                    <p class="text-xs text-slate-500 font-bold uppercase tracking-wider">Drag to set depth</p>
                </div>

                <div class="drill-stage" id="drillStage">
                    <div class="strata-layer layer-top"></div>
                    <div class="strata-layer layer-mid"></div>
                    <div class="strata-layer layer-bot"></div>

                    <div class="drill-hud">
                        <div class="text-[10px] text-slate-400 font-bold uppercase">Current Depth</div>
                        <div class="text-4xl font-black text-blue-900 leading-none" id="depthDisplay">0 <span class="text-sm align-top text-slate-400">ft</span></div>
                    </div>

                    <div class="borehole-path" id="borehole" style="height: 0px;"></div>

                    <div class="drill-bit" id="drillBit" style="top: 0px;">
                        <div class="bit-body"></div>
                        <div class="bit-head"></div>
                    </div>

                    <div class="depth-ruler" id="depthRuler">
                        </div>

                    <div class="expand-notify" id="expandMsg">Scale Expanded!</div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Your Name</label>
                        <input type="text" id="custName" class="w-full p-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500 transition" placeholder="Full Name">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Mobile</label>
                        <div class="relative">
                            <input type="tel" id="custMobile" class="w-full p-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500 transition" placeholder="98765 43210" maxlength="10">
                            <button id="otpBtn" onclick="sendOTP()" class="absolute right-2 top-2 bottom-2 bg-slate-800 text-white px-3 rounded-lg text-xs font-bold hover:bg-black">VERIFY</button>
                        </div>
                        <div id="otpSection" class="hidden mt-2 flex gap-2">
                            <input type="text" id="otpInput" class="w-full p-2 bg-white border border-slate-300 rounded text-center tracking-widest font-bold" placeholder="OTP">
                            <button onclick="verifyOTP()" class="bg-emerald-600 text-white px-4 rounded font-bold hover:bg-emerald-700">OK</button>
                        </div>
                        <div id="recaptcha-container"></div>
                    </div>
                </div>

                <div class="mt-4">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Location</label>
                    <div class="flex gap-2">
                        <input type="text" id="locInput" class="w-full p-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500 transition" placeholder="City / Village">
                        <button onclick="detectGPS()" class="bg-blue-100 text-blue-600 px-4 rounded-xl font-bold text-xs hover:bg-blue-200"><i class="ri-gps-line"></i></button>
                    </div>
                </div>

                <button onclick="goToStep2()" id="genBtn" class="w-full mt-6 bg-gradient-to-r from-blue-700 to-blue-600 text-white font-bold py-4 rounded-xl text-lg shadow-lg shadow-blue-200 hover:shadow-xl hover:scale-[1.01] transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    GENERATE ESTIMATE
                </button>

            </div>
        </div>

        <div id="step-2" class="container mx-auto px-4 pb-12 hidden">
             <div class="flex justify-between items-center max-w-4xl mx-auto mb-4 mt-8">
                <button onclick="goToStep1()" class="text-slate-500 hover:text-blue-600 font-bold text-sm flex items-center gap-1"><i class="ri-arrow-left-line"></i> Edit Depth</button>
                <div class="flex gap-2">
                    <button onclick="downloadPDF()" class="bg-white border border-slate-200 text-slate-700 px-4 py-2 rounded-lg font-bold text-sm hover:bg-slate-50"><i class="ri-file-download-line"></i> PDF</button>
                    <button onclick="shareWhatsApp()" class="bg-emerald-50 text-emerald-600 border border-emerald-200 px-4 py-2 rounded-lg font-bold text-sm hover:bg-emerald-100"><i class="ri-whatsapp-line"></i> Share</button>
                </div>
            </div>

            <div class="est-card max-w-4xl mx-auto" id="invoice-capture">
                <div class="est-header">
                    <div class="flex justify-between items-start">
                        <div class="est-brand">
                            <h2 class="text-2xl font-black text-blue-900">SAGAR BOREWELLS</h2>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Precision Estimate</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs font-bold text-slate-400 uppercase">Total Estimate</div>
                            <div class="est-amount" id="invTotal">â‚¹0</div>
                        </div>
                    </div>
                </div>

                <div class="p-8">
                    <div class="flex items-center gap-2 mb-4 border-b border-slate-200 pb-2">
                        <i class="ri-bar-chart-grouped-line text-blue-600"></i>
                        <span class="text-xs font-bold text-blue-900 uppercase">Drilling Cost Breakdown</span>
                    </div>
                    
                    <table class="est-table">
                        <thead><tr><th>Depth Slab (Feet)</th><th class="text-center">Rate / ft</th><th class="text-right">Amount</th></tr></thead>
                        <tbody id="drillBody"></tbody>
                        <tfoot><tr><td colspan="2">Drilling Subtotal</td><td class="text-right" id="drillSubtotal">â‚¹0</td></tr></tfoot>
                    </table>

                    <div class="flex items-center gap-2 mb-4 border-b border-slate-200 pb-2 mt-6">
                        <i class="ri-shield-check-line text-blue-600"></i>
                        <span class="text-xs font-bold text-blue-900 uppercase">Operational Costs</span>
                    </div>
                    <table class="est-table">
                        <tbody id="opsBody"></tbody>
                        <tfoot><tr><td style="font-weight:700;">Ops Subtotal</td><td class="text-right" id="opsSubtotal">â‚¹0</td></tr></tfoot>
                    </table>

                    <div class="var-box mt-6">
                        <div class="flex items-center gap-2 mb-4">
                            <i class="ri-tools-line text-blue-600"></i>
                            <span class="text-xs font-bold text-blue-900 uppercase">Variable Materials (Charged on Actuals)</span>
                        </div>
                        <div class="var-grid" id="materialsGrid"></div>
                    </div>

                    <div class="text-center mt-10">
                        <button onclick="confirmBooking()" class="bg-slate-900 text-white font-bold py-4 px-12 rounded-xl text-lg hover:bg-black transition shadow-lg w-full md:w-auto">
                            Confirm Booking Request
                        </button>
                        <p class="text-[10px] text-slate-400 mt-3 uppercase tracking-wide">Valid for 30 Days</p>
                    </div>

                </div>
            </div>
        </div>

        <div id="step-3" class="container mx-auto px-4 hidden py-20 text-center">
            <div class="w-24 h-24 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="ri-check-line text-5xl text-emerald-600"></i>
            </div>
            <h1 class="text-3xl font-black text-slate-900 mb-2">Request Received!</h1>
            <p class="text-slate-500 mb-8 max-w-md mx-auto">Our engineer will review your site location and contact you shortly.</p>
            <a href="dashboard.html" class="inline-block py-3 px-8 bg-slate-900 text-white font-bold rounded-xl hover:bg-black">Go to Dashboard</a>
        </div>

    </main>
    <div id="footer-mount"></div>

    <script>
        // --- CONSTANTS ---
        const STAGE_HEIGHT = 500; // px
        const BIT_OFFSET = 30; // Center offset
        let currentMaxDepth = 500; // Starts at 500ft
        let currentDepth = 0;
        let isDragging = false;
        
        // --- ðŸŸ¢ VERTICAL SLIDER LOGIC ---
        const stage = document.getElementById('drillStage');
        const bit = document.getElementById('drillBit');
        const hole = document.getElementById('borehole');
        const display = document.getElementById('depthDisplay');
        const ruler = document.getElementById('depthRuler');
        const notify = document.getElementById('expandMsg');

        function initRuler() {
            ruler.innerHTML = "";
            const steps = 5; // 0, 100, 200, 300, 400, 500
            for(let i=0; i<=steps; i++) {
                const val = Math.round((currentMaxDepth / steps) * i);
                const mark = document.createElement('div');
                mark.className = 'ruler-mark';
                mark.innerText = val;
                mark.style.height = (100/steps) + "%";
                ruler.appendChild(mark);
            }
        }
        initRuler();

        // Drag Events
        bit.addEventListener('mousedown', startDrag);
        bit.addEventListener('touchstart', startDrag, {passive: false});
        
        window.addEventListener('mousemove', onDrag);
        window.addEventListener('touchmove', onDrag, {passive: false});
        
        window.addEventListener('mouseup', stopDrag);
        window.addEventListener('touchend', stopDrag);

        function startDrag(e) {
            isDragging = true;
            e.preventDefault(); // Prevent scrolling on mobile
        }

        function stopDrag() {
            isDragging = false;
        }

        function onDrag(e) {
            if(!isDragging) return;
            e.preventDefault();

            const rect = stage.getBoundingClientRect();
            let clientY = e.clientY || e.touches[0].clientY;
            
            // Calculate relative Y position (0 to STAGE_HEIGHT)
            let y = clientY - rect.top;
            
            // Clamp values
            if(y < 0) y = 0;
            if(y > STAGE_HEIGHT) y = STAGE_HEIGHT;

            // Move UI
            updateDrillPosition(y);

            // ELASTIC EXPANSION CHECK
            if (y > STAGE_HEIGHT * 0.95) {
                expandScale();
            }
        }

        function updateDrillPosition(y) {
            // Update Visuals
            bit.style.top = (y - 10) + 'px'; // -10 to center mouse on bit body
            hole.style.height = y + 'px';
            
            // Calculate Depth (Snap to 10ft)
            const rawDepth = (y / STAGE_HEIGHT) * currentMaxDepth;
            const snappedDepth = Math.round(rawDepth / 10) * 10;
            
            if(snappedDepth !== currentDepth) {
                currentDepth = snappedDepth;
                display.innerHTML = `${currentDepth} <span class="text-sm align-top text-slate-400">ft</span>`;
                
                // Color Logic (Soil -> Rock)
                if(currentDepth > 450) hole.style.backgroundColor = '#ef4444'; // Red (Danger/Deep)
                else if(currentDepth > 200) hole.style.backgroundColor = '#78909c'; // Grey (Rock)
                else hole.style.backgroundColor = '#8d6e63'; // Brown (Soil)
            }
        }

        function expandScale() {
            if(currentMaxDepth >= 2000) return; // Hard limit

            // 1. Increase Scale
            const oldMax = currentMaxDepth;
            currentMaxDepth += 500;
            
            // 2. Notify User
            notify.classList.add('active');
            setTimeout(() => notify.classList.remove('active'), 2000);

            // 3. Recalculate Drill Position to stay visual consistent
            // We want the bit to "jump up" so user can pull it down again
            // Current pixels = STAGE_HEIGHT (bottom)
            // New Depth ratio = oldMax / newMax
            // New Y = STAGE_HEIGHT * (oldMax / newMax)
            
            const newY = STAGE_HEIGHT * (oldMax / currentMaxDepth);
            
            // Animate transition
            isDragging = false; // Force re-grab to prevent glitching
            updateDrillPosition(newY);
            initRuler(); // Redraw numbers
        }

        // ðŸŸ¢ AUTH & CONFIG LOADER
        if(typeof firebase !== 'undefined' && CONTACT_INFO.firebase_config) {
            if(!firebase.apps.length) firebase.initializeApp(CONTACT_INFO.firebase_config);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Load Rates
        let globalRates = QUOTE_CONFIG.DEFAULT_RATES;
        db.collection('settings').doc('rates').get().then(doc => { if(doc.exists) globalRates = {...globalRates, ...doc.data()}; });

        // Load Materials Grid
        const matGrid = document.getElementById('materialsGrid');
        if(matGrid && QUOTE_CONFIG.MATERIALS) {
            matGrid.innerHTML = QUOTE_CONFIG.MATERIALS.map(m => `
                <div class="var-item">
                    <span class="font-bold text-slate-700 text-xs uppercase">${m.label}</span>
                    <span class="var-badge">â‚¹${m.price}${m.unit}</span>
                </div>
            `).join('');
        }

        // Auth Listener
        auth.onAuthStateChanged((user) => {
            const btn = document.getElementById('genBtn');
            if (user) {
                document.getElementById('custMobile').value = user.phoneNumber.replace('+91', '');
                document.getElementById('custMobile').disabled = true;
                document.getElementById('otpBtn').classList.add('hidden');
                btn.disabled = false;
            } else { btn.disabled = true; }
        });

        // ðŸŸ¢ CALCULATION ENGINE
        function goToStep2() {
            if(!currentDepth) return alert("Drag the drill to set depth!");
            
            const name = document.getElementById('custName').value;
            const loc = document.getElementById('locInput').value;
            if(!name || !loc) return alert("Enter Name and Location");

            // --- PRICING LOGIC ---
            let drillCost = 0;
            let drillHtml = "";
            let processedDepth = 0;
            let currentRate = globalRates.base_rate;
            const jumps = globalRates.jumps;

            // 1. Drilling
            // Block 1: 0-100
            const firstBlock = Math.min(currentDepth, 100);
            if(firstBlock > 0) {
                const cost = firstBlock * currentRate;
                drillCost += cost;
                drillHtml += `<tr><td>0 - ${firstBlock} ft</td><td class="text-center">â‚¹${currentRate}</td><td class="text-right">â‚¹${cost.toLocaleString()}</td></tr>`;
                processedDepth += firstBlock;
            }

            // Next Blocks (50ft slabs)
            while(processedDepth < currentDepth) {
                let jump = jumps.phase_1; // 10
                if(processedDepth >= 450) jump = jumps.phase_3; // 30
                else if(processedDepth >= 200) jump = jumps.phase_2; // 20
                
                currentRate += jump;
                
                let nextChunk = Math.min(50, currentDepth - processedDepth);
                const chunkCost = nextChunk * currentRate;
                drillCost += chunkCost;
                
                drillHtml += `<tr><td>${processedDepth} - ${processedDepth+nextChunk} ft</td><td class="text-center">â‚¹${currentRate}</td><td class="text-right">â‚¹${chunkCost.toLocaleString()}</td></tr>`;
                processedDepth += nextChunk;
            }

            // 2. Ops
            const opsCost = QUOTE_CONFIG.LABOUR_CHARGE; // + Transport if needed
            let opsHtml = `<tr><td>Site Setup & Labour</td><td class="text-right">â‚¹${opsCost.toLocaleString()}</td></tr>`;

            // Render
            document.getElementById('drillBody').innerHTML = drillHtml;
            document.getElementById('drillSubtotal').innerText = "â‚¹" + drillCost.toLocaleString();
            document.getElementById('opsBody').innerHTML = opsHtml;
            document.getElementById('opsSubtotal').innerText = "â‚¹" + opsCost.toLocaleString();
            document.getElementById('invTotal').innerText = "â‚¹" + (drillCost + opsCost).toLocaleString();

            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('step-2').classList.remove('hidden');
            window.scrollTo(0,0);
        }

        // Utils (Same as before)
        function goToStep1() { document.getElementById('step-2').classList.add('hidden'); document.getElementById('step-1').classList.remove('hidden'); }
        
        function sendOTP() {
            const ph = document.getElementById('custMobile').value;
            if(ph.length!=10) return alert("Invalid Number");
            if(!window.recaptchaVerifier) window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {size:'invisible'});
            auth.signInWithPhoneNumber('+91'+ph, window.recaptchaVerifier).then(cr => {
                window.confirmationResult = cr; document.getElementById('otpSection').classList.remove('hidden'); document.getElementById('otpBtn').classList.add('hidden');
            }).catch(e => alert("SMS Error: "+e.message));
        }
        function verifyOTP() {
            window.confirmationResult.confirm(document.getElementById('otpInput').value).then(()=> document.getElementById('otpSection').classList.add('hidden')).catch(()=>alert("Bad OTP"));
        }

        // ... Existing Maps & PDF logic can be reused here ...
        function downloadPDF() {
            const el = document.getElementById('invoice-capture');
            const opt = { margin: 0.2, filename: 'Estimate.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
            html2pdf().set(opt).from(el).save();
        }
    </script>
</body>
</html>
