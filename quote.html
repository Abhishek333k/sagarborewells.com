<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Quote | Sagar Borewells</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/layout.js"></script>
    <script src="assets/js/quote_constants.js"></script> 
    <script src="assets/js/pdf_template.js"></script>

    <style>
        :root { --primary: #1e3a8a; --soil-top: #8d6e63; --soil-mid: #d4a373; --soil-deep: #4b5563; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #1e293b; }
        
        /* CARD LAYOUT */
        .quote-container { max-width: 1100px; margin: 40px auto; display: grid; grid-template-columns: 1fr 1fr; gap: 0; background: white; border-radius: 24px; box-shadow: 0 20px 60px -10px rgba(0,0,0,0.1); overflow: hidden; }
        
        /* LEFT COLUMN (Form) */
        .form-col { padding: 40px; display: flex; flex-direction: column; justify-content: center; }
        .form-label { font-weight: 800; font-size: 0.75rem; text-transform: uppercase; color: #64748b; margin-bottom: 6px; display: block; letter-spacing: 0.5px; }
        .custom-input { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; font-weight: 600; font-size: 1rem; color: #1e293b; background: #f8fafc; outline: none; transition: 0.3s; }
        .custom-input:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 4px rgba(30, 58, 138, 0.1); }
        .btn-primary { background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; font-weight: 700; padding: 16px; border-radius: 12px; width: 100%; font-size: 1.1rem; transition: 0.2s; margin-top: 20px; box-shadow: 0 10px 20px -5px rgba(30, 58, 138, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; transform: none; }

        /* RIGHT COLUMN (The Drill Rig) */
        .drill-col { background: #f1f5f9; padding: 40px; border-left: 1px solid #e2e8f0; position: relative; display: flex; flex-direction: column; align-items: center; }
        
        /* VERTICAL SLIDER (The Hole) */
        .drill-track-container { position: relative; height: 500px; width: 80px; margin: 20px 0; }
        
        /* Geological Layers (Background) */
        .geo-layers { 
            position: absolute; inset: 0; border-radius: 40px; overflow: hidden; border: 2px solid #cbd5e1; 
            background: linear-gradient(to bottom, var(--soil-top) 0%, var(--soil-mid) 30%, var(--soil-deep) 100%);
            opacity: 0.2;
        }

        /* The Borehole (Dark line expanding down) */
        .borehole {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 12px; background: #0f172a; 
            height: 0%; /* Dynamic */
            transition: height 0.1s linear;
            z-index: 10;
        }

        /* The Drill Bit (Thumb) */
        .drill-bit {
            position: absolute; left: 50%; top: 0%; transform: translate(-50%, -50%);
            width: 40px; height: 50px;
            cursor: grab; z-index: 20;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
        }
        .drill-bit:active { cursor: grabbing; }
        /* CSS Drill Bit Shape */
        .bit-body { width: 100%; height: 100%; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ef4444"><path d="M12 2L2 22h20L12 2zm0 4l5 14H7l5-14z"/></svg>') no-repeat center/contain; transition: transform 0.1s; }
        .spinning { animation: spinBit 0.2s linear infinite; }
        @keyframes spinBit { 0% { transform: scaleX(1); } 50% { transform: scaleX(0.5); } 100% { transform: scaleX(1); } }

        /* Depth Markers */
        .depth-marker { position: absolute; right: -40px; font-size: 10px; font-weight: bold; color: #64748b; transform: translateY(-50%); transition: top 0.3s; }

        /* Controls */
        .preset-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; margin-top: auto; }
        .preset-btn { background: white; border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; font-size: 0.85rem; font-weight: 700; color: #475569; transition: 0.2s; }
        .preset-btn:hover { border-color: var(--primary); color: var(--primary); background: #eff6ff; }
        
        .depth-display { font-size: 3rem; font-weight: 900; color: var(--primary); line-height: 1; text-align: center; margin-bottom: 10px; }
        .depth-unit { font-size: 1rem; color: #94a3b8; font-weight: 700; }

        /* Responsive */
        @media (max-width: 768px) {
            .quote-container { grid-template-columns: 1fr; margin: 10px; }
            .drill-col { border-left: none; border-top: 1px solid #e2e8f0; padding: 30px 20px; }
        }

        /* RESULT TABLE */
        .est-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        .est-table th { text-align: left; padding: 10px; color: #64748b; font-size: 0.75rem; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; }
        .est-table td { padding: 12px 10px; border-bottom: 1px dashed #e2e8f0; font-weight: 600; }
        .est-table tr:last-child td { border-bottom: none; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="navbar-mount"></div>

    <main class="flex-grow">
        
        <div id="step-1" class="fade-in-up">
            <div class="quote-container">
                
                <div class="form-col">
                    <div class="mb-8">
                        <h1 class="text-3xl font-extrabold text-slate-900">Get Quote</h1>
                        <p class="text-sm text-slate-500 font-bold mt-1">Configure your borewell requirements.</p>
                    </div>

                    <div class="space-y-5">
                        <div>
                            <label class="form-label">Full Name</label>
                            <input type="text" id="custName" class="custom-input" placeholder="Your Name">
                        </div>
                        <div>
                            <label class="form-label">Mobile Number</label>
                            <div class="relative">
                                <input type="tel" id="custMobile" class="custom-input pr-24" placeholder="98765 43210" maxlength="10">
                                <button id="sendOtpBtn" onclick="sendOTP()" class="absolute right-2 top-2 bottom-2 bg-slate-800 text-white px-3 rounded-lg font-bold text-xs hover:bg-black">VERIFY</button>
                                <div id="verifiedBadge" class="hidden absolute right-3 top-4 text-emerald-600 font-bold text-xs flex items-center gap-1"><i class="ri-checkbox-circle-fill"></i> VERIFIED</div>
                            </div>
                            <div id="otpSection" class="hidden mt-2 flex gap-2">
                                <input type="text" id="otpInput" class="custom-input text-center" placeholder="OTP" maxlength="6">
                                <button onclick="verifyOTP()" class="bg-emerald-600 text-white px-4 rounded-lg font-bold hover:bg-emerald-700">OK</button>
                            </div>
                            <div id="recaptcha-container"></div>
                        </div>
                        <div>
                            <label class="form-label">Site Location</label>
                            <div class="relative flex gap-2">
                                <input type="text" id="locInput" class="custom-input pr-12" placeholder="Start typing address...">
                                <button onclick="detectGPS()" class="absolute right-2 top-2 bottom-2 text-blue-600 px-2 rounded hover:bg-blue-50" title="Detect GPS"><i class="ri-map-pin-user-fill text-xl"></i></button>
                            </div>
                            <p id="distDisplay" class="text-xs text-right mt-1 text-slate-400 font-bold"></p>
                        </div>
                    </div>

                    <button id="generateBtn" onclick="calculateQuote()" class="btn-primary" disabled>
                        GENERATE ESTIMATE <i class="ri-arrow-right-line ml-2"></i>
                    </button>
                </div>

                <div class="drill-col">
                    <div class="text-center mb-4">
                        <div class="depth-display"><span id="depthVal">100</span><span class="depth-unit">ft</span></div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Target Depth</p>
                    </div>

                    <div class="drill-track-container" id="drillTrack">
                        <div class="geo-layers"></div>
                        <div class="borehole" id="boreHole"></div>
                        
                        <div id="scaleMarkers"></div>

                        <div class="drill-bit" id="drillBit">
                            <div class="bit-body" id="bitVisual"></div>
                        </div>
                    </div>

                    <div class="w-full max-w-xs mt-4">
                        <label class="form-label text-center mb-2">Quick Presets</label>
                        <div class="preset-grid">
                            <button class="preset-btn" onclick="setDepth(150)">150 FT</button>
                            <button class="preset-btn" onclick="setDepth(200)">200 FT</button>
                            <button class="preset-btn" onclick="setDepth(300)">300 FT</button>
                            <button class="preset-btn" onclick="setDepth(500)">500 FT</button>
                        </div>
                        <div class="mt-4">
                            <label class="form-label text-center">Manual Entry</label>
                            <input type="number" id="manualDepth" class="custom-input text-center" value="100" oninput="setDepth(this.value)">
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div id="step-2" class="container mx-auto px-4 fade-in-up py-12 hidden">
            <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
                <div class="bg-slate-900 p-6 flex justify-between items-center text-white">
                    <div>
                        <h2 class="text-xl font-bold">ESTIMATED COST</h2>
                        <p class="text-xs text-slate-400 font-mono" id="resId">QT-2024-XXXX</p>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-extrabold text-emerald-400" id="resTotal">â‚¹0</div>
                        <div class="text-xs text-slate-400">Approximate Total</div>
                    </div>
                </div>
                
                <div class="p-8" id="invoice-content">
                    <div class="flex justify-between mb-6 bg-slate-50 p-4 rounded-lg border border-slate-100">
                        <div><span class="text-xs font-bold text-slate-500 uppercase block">Location</span><span class="font-bold text-slate-800" id="resLoc">--</span></div>
                        <div class="text-right"><span class="text-xs font-bold text-slate-500 uppercase block">Depth</span><span class="font-bold text-blue-600" id="resDepth">--</span></div>
                    </div>

                    <h3 class="text-xs font-bold text-slate-900 uppercase border-b border-slate-200 pb-2">Drilling Breakdown</h3>
                    <table class="est-table">
                        <tbody id="breakdownBody"></tbody>
                    </table>

                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 mt-6">
                        <h3 class="text-xs font-bold text-blue-800 uppercase mb-2">Variable Costs (Materials)</h3>
                        <div class="grid grid-cols-2 gap-2 text-sm" id="matList"></div>
                    </div>

                    <div class="flex gap-4 mt-8">
                        <button onclick="location.reload()" class="flex-1 py-3 border border-slate-300 rounded-xl font-bold text-slate-600 hover:bg-slate-50">Edit</button>
                        <button onclick="confirmBooking()" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700 shadow-lg shadow-emerald-200">Book Visit</button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="footer-mount"></div>

    <script>
        // FIREBASE INIT
        if(typeof firebase !== 'undefined' && CONTACT_INFO.firebase_config) {
            if(!firebase.apps.length) firebase.initializeApp(CONTACT_INFO.firebase_config);
        }
        const db = firebase.firestore();

        // ðŸŸ¢ DRILL RIG LOGIC (Vertical Slider)
        const drillTrack = document.getElementById('drillTrack');
        const drillBit = document.getElementById('drillBit');
        const boreHole = document.getElementById('boreHole');
        const bitVisual = document.getElementById('bitVisual');
        
        let isDragging = false;
        let currentMaxScale = 500; // Elastic Limit
        let currentDepth = 100;

        function initDrillRig() {
            renderScaleMarkers();
            updateDrillPosition();

            // Mouse Events
            drillBit.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', stopDrag);
            
            // Touch Events
            drillBit.addEventListener('touchstart', startDrag);
            document.addEventListener('touchmove', onDrag);
            document.addEventListener('touchend', stopDrag);
        }

        function renderScaleMarkers() {
            const container = document.getElementById('scaleMarkers');
            container.innerHTML = '';
            const step = currentMaxScale / 5; // 5 markers
            for(let i=0; i<=currentMaxScale; i+=step) {
                const mk = document.createElement('div');
                mk.className = 'depth-marker';
                mk.innerText = Math.round(i) + " ft";
                mk.style.top = (i / currentMaxScale * 100) + "%";
                container.appendChild(mk);
            }
        }

        function startDrag(e) { 
            isDragging = true; 
            bitVisual.classList.add('spinning'); // Animate Bit
            e.preventDefault(); 
        }
        
        function stopDrag() { 
            isDragging = false; 
            bitVisual.classList.remove('spinning'); 
        }

        function onDrag(e) {
            if(!isDragging) return;
            
            const rect = drillTrack.getBoundingClientRect();
            let clientY = e.touches ? e.touches[0].clientY : e.clientY;
            let relativeY = clientY - rect.top;
            
            // Clamp
            if(relativeY < 0) relativeY = 0;
            if(relativeY > rect.height) relativeY = rect.height;

            // Calculate Depth
            let pct = relativeY / rect.height;
            let rawDepth = Math.round(pct * currentMaxScale);
            
            // Snap to 10ft
            currentDepth = Math.round(rawDepth / 10) * 10;
            if(currentDepth < 100) currentDepth = 100; // Min depth

            // Elastic Expansion (The "Push")
            if(pct > 0.95 && currentMaxScale < 2000) {
                expandScale();
            }

            updateUI();
        }

        function expandScale() {
            isDragging = false; // Reset drag to prevent jumping
            currentMaxScale += 500;
            renderScaleMarkers();
            // Recalculate position on new scale
            updateDrillPosition(); 
        }

        function setDepth(val) {
            currentDepth = parseInt(val);
            // Auto expand if manual entry is huge
            while(currentDepth > currentMaxScale) {
                currentMaxScale += 500;
            }
            renderScaleMarkers();
            updateUI();
        }

        function updateUI() {
            document.getElementById('depthVal').innerText = currentDepth;
            document.getElementById('manualDepth').value = currentDepth;
            updateDrillPosition();
        }

        function updateDrillPosition() {
            const pct = (currentDepth / currentMaxScale) * 100;
            drillBit.style.top = pct + "%";
            boreHole.style.height = pct + "%";
            
            // Color Logic (Brown -> Grey)
            if(currentDepth > 200) boreHole.style.background = "#4b5563"; // Rock
            else boreHole.style.background = "#0f172a"; // Soil
        }

        // ðŸŸ¢ PRICING ENGINE (Slab Logic)
        function calculateQuote() {
            const { RATES, LABOUR_CHARGE, MATERIALS, TRANSPORT_THRESHOLD_KM, TRANSPORT_BASE_RATE } = QUOTE_CONFIG;
            
            let totalCost = 0;
            let breakdownHtml = "";
            let remainingDepth = currentDepth;
            let trackedDepth = 0;

            // 1. DRILLING SLABS
            // Slab 1: 0-100ft (Base Rate)
            if(remainingDepth > 0) {
                const chunk = Math.min(remainingDepth, 100);
                const cost = chunk * RATES.base_rate;
                totalCost += cost;
                breakdownHtml += `<tr><td>0 - 100 ft</td><td class="text-center">â‚¹${RATES.base_rate}</td><td class="text-right">â‚¹${cost.toLocaleString()}</td></tr>`;
                remainingDepth -= chunk;
                trackedDepth += chunk;
            }

            // Loop for remaining slabs (50ft chunks)
            let currentRate = RATES.base_rate; // 70
            
            while(remainingDepth > 0) {
                // Determine Jump
                let jump = RATES.jumps.phase_1; // +10
                if(trackedDepth >= 450) jump = RATES.jumps.phase_3; // +30
                else if(trackedDepth >= 200) jump = RATES.jumps.phase_2; // +20
                
                currentRate += jump;
                
                const chunk = Math.min(remainingDepth, 50);
                const cost = chunk * currentRate;
                totalCost += cost;
                
                breakdownHtml += `<tr><td>${trackedDepth + 1} - ${trackedDepth + chunk} ft</td><td class="text-center">â‚¹${currentRate}</td><td class="text-right">â‚¹${cost.toLocaleString()}</td></tr>`;
                
                remainingDepth -= chunk;
                trackedDepth += chunk;
            }

            // 2. OPERATIONAL
            // Transport
            if(transportDist > TRANSPORT_THRESHOLD_KM) {
                const extraKm = transportDist - TRANSPORT_THRESHOLD_KM;
                const charges = Math.ceil(extraKm / 30);
                const transCost = charges * TRANSPORT_BASE_RATE;
                totalCost += transCost;
                breakdownHtml += `<tr><td>Transport (${extraKm.toFixed(1)} km extra)</td><td class="text-center">--</td><td class="text-right">â‚¹${transCost.toLocaleString()}</td></tr>`;
            }
            
            // Labour
            totalCost += LABOUR_CHARGE;
            breakdownHtml += `<tr><td>Site Setup & Labour</td><td class="text-center">Fixed</td><td class="text-right">â‚¹${LABOUR_CHARGE.toLocaleString()}</td></tr>`;

            // 3. RENDER
            document.getElementById('resTotal').innerText = "â‚¹" + totalCost.toLocaleString();
            document.getElementById('breakdownBody').innerHTML = breakdownHtml;
            document.getElementById('resLoc').innerText = document.getElementById('locInput').value;
            document.getElementById('resDepth').innerText = currentDepth + " ft";
            
            // Materials List
            const matHtml = MATERIALS.map(m => `<div><span class="text-xs text-slate-500 block">${m.label}</span><span class="font-bold text-slate-800">â‚¹${m.price} ${m.unit}</span></div>`).join('');
            document.getElementById('matList').innerHTML = matHtml;

            // Show Result
            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('step-2').classList.remove('hidden');
            window.scrollTo(0,0);
        }

        // ðŸŸ¢ AUTH & MAPS (Standard)
        firebase.auth().onAuthStateChanged(user => {
            const btn = document.getElementById('generateBtn');
            if(user) {
                document.getElementById('custMobile').value = user.phoneNumber.replace('+91','');
                document.getElementById('sendOtpBtn').classList.add('hidden');
                document.getElementById('verifiedBadge').classList.remove('hidden');
                btn.disabled = false;
            }
        });

        function sendOTP() {
            const p = document.getElementById('custMobile').value;
            if(p.length!=10) return alert("Invalid Number");
            if(!window.recaptchaVerifier) window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {size:'invisible'});
            firebase.auth().signInWithPhoneNumber('+91'+p, window.recaptchaVerifier).then(cr=>{
                window.confirmationResult=cr; document.getElementById('otpSection').classList.remove('hidden'); document.getElementById('sendOtpBtn').classList.add('hidden');
            });
        }
        function verifyOTP() { window.confirmationResult.confirm(document.getElementById('otpInput').value).then(()=>document.getElementById('otpSection').classList.add('hidden')); }
        
        // Maps Logic
        let transportDist = 0;
        function detectGPS() {
            if(navigator.geolocation) navigator.geolocation.getCurrentPosition(pos=>{
                const {latitude, longitude} = pos.coords;
                // Simple Distance Calc
                const R = 6371; 
                const dLat = (latitude - QUOTE_CONFIG.OFFICE_LOCATION.lat) * Math.PI/180;
                const dLon = (longitude - QUOTE_CONFIG.OFFICE_LOCATION.lng) * Math.PI/180;
                const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(QUOTE_CONFIG.OFFICE_LOCATION.lat*Math.PI/180)*Math.cos(latitude*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                transportDist = R * c;
                
                document.getElementById('distDisplay').innerText = `Distance: ${transportDist.toFixed(1)} km`;
                // Reverse Geocode for Display
                new google.maps.Geocoder().geocode({location:{lat:latitude, lng:longitude}}, (res,s)=>{
                    if(s==='OK') document.getElementById('locInput').value = res[0].formatted_address;
                });
            });
        }
        
        function confirmBooking() {
            // Save to Firestore 'leads'
            const data = {
                name: document.getElementById('custName').value,
                mobile: "+91"+document.getElementById('custMobile').value,
                loc: document.getElementById('resLoc').innerText,
                depth: currentDepth,
                total: document.getElementById('resTotal').innerText.replace(/[^0-9]/g, ''),
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'New Quote'
            };
            db.collection('leads').add(data).then(() => {
                alert("Booking Request Sent! Our engineer will call you.");
                location.reload();
            });
        }

        // Initialize
        document.addEventListener("DOMContentLoaded", initDrillRig);
        
        const s = document.createElement('script'); 
        s.src = `https://maps.googleapis.com/maps/api/js?key=${CONTACT_INFO.google_maps_key}&libraries=places`; 
        s.async = true; s.defer = true; 
        document.body.appendChild(s);

    </script>
</body>
</html>
